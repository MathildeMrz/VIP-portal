<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>UserData.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">coverage</a> &gt; <a href="../index.html" class="el_bundle">vip-core</a> &gt; <a href="index.source.html" class="el_package">fr.insalyon.creatis.vip.core.server.dao.mysql</a> &gt; <span class="el_source">UserData.java</span></div><h1>UserData.java</h1><pre class="source lang-java linenums">/*
 * Copyright and authors: see LICENSE.txt in base repository.
 *
 * This software is a web portal for pipeline execution on distributed systems.
 *
 * This software is governed by the CeCILL-B license under French law and
 * abiding by the rules of distribution of free software.  You can  use,
 * modify and/ or redistribute the software under the terms of the CeCILL-B
 * license as circulated by CEA, CNRS and INRIA at the following URL
 * &quot;http://www.cecill.info&quot;.
 *
 * As a counterpart to the access to the source code and  rights to copy,
 * modify and redistribute granted by the license, users are provided only
 * with a limited warranty  and the software's author,  the holder of the
 * economic rights,  and the successive licensors  have only  limited
 * liability.
 *
 * In this respect, the user's attention is drawn to the risks associated
 * with loading,  using,  modifying and/or developing or reproducing the
 * software by the user in light of its specific status of free software,
 * that may mean  that it is complicated to manipulate,  and  that  also
 * therefore means  that it is reserved for developers  and  experienced
 * professionals having in-depth computer knowledge. Users are therefore
 * encouraged to load and test the software's suitability as regards their
 * requirements in conditions enabling the security of their systems and/or
 * data to be ensured and,  more generally, to use and operate it in the
 * same conditions as regards security.
 *
 * The fact that you are presently reading this means that you have had
 * knowledge of the CeCILL-B license and that you accept its terms.
 */
package fr.insalyon.creatis.vip.core.server.dao.mysql;

import fr.insalyon.creatis.vip.core.client.bean.User;
import fr.insalyon.creatis.vip.core.client.view.user.UserLevel;
import fr.insalyon.creatis.vip.core.client.view.util.CountryCode;
import fr.insalyon.creatis.vip.core.server.business.StatsBusiness.UserSearchCriteria;
import fr.insalyon.creatis.vip.core.server.dao.DAOException;
import fr.insalyon.creatis.vip.core.server.dao.UserDAO;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.jdbc.core.support.JdbcDaoSupport;
import org.springframework.stereotype.Repository;
import org.springframework.transaction.annotation.Transactional;

import javax.sql.DataSource;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.sql.Timestamp;
import java.util.AbstractMap.SimpleEntry;
import java.util.*;

/**
 *
 * @author Rafael Ferreira da Silva, Tristan Glatard
 */
@Repository
@Transactional
<span class="fc" id="L61">public class UserData extends JdbcDaoSupport implements UserDAO {</span>

<span class="fc" id="L63">    private final Logger logger = LoggerFactory.getLogger(getClass());</span>

    @Autowired
    public void useDataSource(DataSource dataSource) {
<span class="fc" id="L67">        setDataSource(dataSource);</span>
<span class="fc" id="L68">    }</span>

    /**
     * Adds a user
     *
     * @param user
     * @return
     */

    // Throws an exception if the user we try to add has an email already present in the database
    @Override
    public void add(User user) throws DAOException {
        try {
<span class="fc" id="L81">            PreparedStatement ps = getConnection().prepareStatement(</span>
                    &quot;INSERT INTO VIPUsers(&quot;
                    + &quot;email, pass, first_name, last_name, institution, &quot;
                    + &quot;code, confirmed, folder, registration, last_login, level, &quot;
                    + &quot;country_code, max_simulations, termsUse,lastUpdatePublications,&quot;
                    + &quot;failed_authentications, account_locked) &quot;
                    + &quot;VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)&quot;);

<span class="fc" id="L89">            ps.setString(1, user.getEmail());</span>
<span class="fc" id="L90">            ps.setString(2, user.getPassword());</span>
<span class="fc" id="L91">            ps.setString(3, user.getFirstName());</span>
<span class="fc" id="L92">            ps.setString(4, user.getLastName());</span>
<span class="fc" id="L93">            ps.setString(5, user.getInstitution());</span>
<span class="fc" id="L94">            ps.setString(6, user.getCode());</span>
<span class="fc" id="L95">            ps.setBoolean(7, user.isConfirmed());</span>
<span class="fc" id="L96">            ps.setString(8, user.getFolder());</span>
<span class="fc" id="L97">            ps.setTimestamp(9, new Timestamp(user.getRegistration().getTime()));</span>
<span class="fc" id="L98">            ps.setTimestamp(10, new Timestamp(user.getLastLogin().getTime()));</span>
<span class="fc" id="L99">            ps.setString(11, user.getLevel().name());</span>
<span class="fc" id="L100">            ps.setString(12, user.getCountryCode().name());</span>
<span class="fc" id="L101">            ps.setInt(13, user.getMaxRunningSimulations());</span>
<span class="fc" id="L102">            ps.setTimestamp(14, user.getTermsOfUse());</span>
<span class="fc" id="L103">            ps.setTimestamp(15, user.getLastUpdatePublications());</span>
<span class="fc" id="L104">            ps.setInt(16, 0);</span>
<span class="fc" id="L105">            ps.setBoolean(17, false);</span>

<span class="fc" id="L107">            ps.execute();</span>
<span class="fc" id="L108">            ps.close();</span>

<span class="fc" id="L110">        } catch (SQLException ex) {</span>
<span class="pc bpc" id="L111" title="1 of 2 branches missed.">            if (ex.getMessage().contains(&quot;Unique index or primary key&quot;)) {</span>
<span class="fc" id="L112">                logger.error(&quot;There is an existing account associated with the email: {} or with this {first name,last name} ({})&quot;, user.getEmail(), ex.getMessage());</span>
<span class="fc" id="L113">                throw new DAOException(&quot;There is an existing account associated with this email : &quot;+user.getEmail()+&quot; or with this first name,last name : &quot;+user.getFirstName()+&quot;,&quot;+user.getLastName(), ex);</span>
            } else {
<span class="nc" id="L115">                logger.error(&quot;Error adding user {}&quot;, user.getEmail(), ex);</span>
<span class="nc" id="L116">                throw new DAOException(ex);</span>
            }
<span class="fc" id="L118">        }</span>
<span class="fc" id="L119">    }</span>

    /**
     *
     * @param email
     * @return
     * @throws DAOException
     */
    public boolean isUser(String email) throws DAOException {
        try {
<span class="fc" id="L129">            PreparedStatement ps = getConnection().prepareStatement(&quot;SELECT *&quot;</span>
                    + &quot;FROM VIPUsers &quot;
                    + &quot;WHERE email=?&quot;);

<span class="fc" id="L133">            ps.setString(1, email);</span>
<span class="fc" id="L134">            ResultSet rs = ps.executeQuery();</span>

<span class="fc" id="L136">            return rs.next();</span>

<span class="nc" id="L138">        } catch (SQLException e) {</span>
<span class="nc" id="L139">            throw new RuntimeException(e);</span>
        }
    }


    /**
     *
     * @param email
     * @throws DAOException
     */

    // Throws an exception if the email we have to find is not present in the database
    @Override
    public void remove(String email) throws DAOException {
        try {
<span class="fc" id="L154">            PreparedStatement ps = getConnection().prepareStatement(&quot;DELETE &quot;</span>
                    + &quot;FROM VIPUsers WHERE email=?&quot;);

<span class="fc" id="L157">            ps.setString(1, email);</span>

            //ps.execute();

            //////////ADDED//////////
<span class="fc" id="L162">            int rs = ps.executeUpdate();</span>

<span class="pc bpc" id="L164" title="1 of 2 branches missed.">            if (rs == 0) {</span>
<span class="nc" id="L165">                logger.error(&quot;There is no user registered with the e-mail {}&quot;, email);</span>
<span class="nc" id="L166">                throw new DAOException(&quot;There is no user registered with the e-mail : &quot; + email);</span>
            }
            //////////ADDED//////////

<span class="fc" id="L170">            ps.close();</span>

<span class="nc" id="L172">        } catch (SQLException ex) {</span>
<span class="nc" id="L173">            logger.error(&quot;Error removing user {}&quot;, email, ex);</span>
<span class="nc" id="L174">            throw new DAOException(ex);</span>
<span class="fc" id="L175">        }</span>
<span class="fc" id="L176">    }</span>

    /**
     *
     * @param user
     * @throws DAOException
     */
    @Override
    public void update(User user) throws DAOException {

        try {
<span class="fc" id="L187">            PreparedStatement ps = getConnection().prepareStatement(&quot;UPDATE &quot;</span>
                    + &quot;VIPUsers SET &quot;
                    + &quot;first_name = ?, last_name = ?, institution = ?, &quot;
                    + &quot;folder = ?, country_code = ? &quot;
                    + &quot;WHERE email = ?&quot;);

<span class="fc" id="L193">            ps.setString(1, user.getFirstName());</span>
<span class="fc" id="L194">            ps.setString(2, user.getLastName());</span>
<span class="fc" id="L195">            ps.setString(3, user.getInstitution());</span>
<span class="fc" id="L196">            ps.setString(4, user.getFolder());</span>
<span class="fc" id="L197">            ps.setString(5, user.getCountryCode().name());</span>
<span class="fc" id="L198">            ps.setString(6, user.getEmail());</span>

            //ps.executeUpdate();

            //////////ADDED//////////
<span class="fc" id="L203">            int rs = ps.executeUpdate();</span>

<span class="pc bpc" id="L205" title="1 of 2 branches missed.">            if (rs == 0) {</span>
<span class="nc" id="L206">                logger.error(&quot;There is no user registered with the e-mail {}&quot;, user.getEmail());</span>
<span class="nc" id="L207">                throw new DAOException(&quot;There is no user registered with the e-mail : &quot; + user.getEmail());</span>
            }
            //////////ADDED//////////

<span class="fc" id="L211">            ps.close();</span>

<span class="nc" id="L213">        } catch (SQLException ex) {</span>
<span class="nc" id="L214">            logger.error(&quot;Error updating user {}&quot;, user.getEmail(), ex);</span>
<span class="nc" id="L215">            throw new DAOException(ex);</span>
<span class="fc" id="L216">        }</span>
<span class="fc" id="L217">    }</span>


    /************************************** Not modified **************************************/


    /**
     *
     * @return @throws DAOException
     */
    @Override
    public List&lt;User&gt; getUsers() throws DAOException {

        try {
<span class="fc" id="L231">            PreparedStatement ps = getConnection().prepareStatement(&quot;SELECT &quot;</span>
                    + &quot;email, next_email, first_name, last_name, institution, &quot;
                    + &quot;code, confirmed, folder, registration, last_login, &quot;
                    + &quot;level, country_code, max_simulations, termsUse, lastUpdatePublications,&quot;
                    + &quot;failed_authentications, account_locked &quot;
                    + &quot;FROM VIPUsers &quot;
                    + &quot;ORDER BY LOWER(first_name), LOWER(last_name)&quot;);

<span class="fc" id="L239">            ResultSet rs = ps.executeQuery();</span>
<span class="fc" id="L240">            List&lt;User&gt; users = new ArrayList&lt;User&gt;();</span>

<span class="fc bfc" id="L242" title="All 2 branches covered.">            while (rs.next())</span>
            {
<span class="fc" id="L244">                users.add(new User(</span>
<span class="fc" id="L245">                        rs.getString(&quot;first_name&quot;), rs.getString(&quot;last_name&quot;),</span>
<span class="fc" id="L246">                        rs.getString(&quot;email&quot;), rs.getString(&quot;next_email&quot;),</span>
<span class="fc" id="L247">                        rs.getString(&quot;institution&quot;),</span>
<span class="fc" id="L248">                        &quot;&quot;, rs.getBoolean(&quot;confirmed&quot;),</span>
<span class="fc" id="L249">                        rs.getString(&quot;code&quot;), rs.getString(&quot;folder&quot;), &quot;&quot;,</span>
<span class="fc" id="L250">                        new Date(rs.getTimestamp(&quot;registration&quot;).getTime()),</span>
<span class="fc" id="L251">                        new Date(rs.getTimestamp(&quot;last_login&quot;).getTime()),</span>
<span class="fc" id="L252">                        UserLevel.valueOf(rs.getString(&quot;level&quot;)),</span>
<span class="fc" id="L253">                        CountryCode.valueOf(rs.getString(&quot;country_code&quot;)),</span>
<span class="fc" id="L254">                        rs.getInt(&quot;max_simulations&quot;),</span>
<span class="fc" id="L255">                        rs.getTimestamp(&quot;termsUse&quot;),</span>
<span class="fc" id="L256">                        rs.getTimestamp(&quot;lastUpdatePublications&quot;),</span>
<span class="fc" id="L257">                        rs.getInt(&quot;failed_authentications&quot;),</span>
<span class="fc" id="L258">                        rs.getBoolean(&quot;account_locked&quot;)));</span>
            }
<span class="fc" id="L260">            ps.close();</span>
<span class="fc" id="L261">            return users;</span>

<span class="nc" id="L263">        } catch (SQLException ex) {</span>
<span class="nc" id="L264">            logger.error(&quot;Error getting all users&quot;, ex);</span>
<span class="nc" id="L265">            throw new DAOException(ex);</span>
        }
    }

    @Override
    public List&lt;User&gt; searchUsers(
            UserSearchCriteria searchCriteria) throws DAOException {

        try {
<span class="nc" id="L274">            StringBuilder query = new StringBuilder(&quot;SELECT &quot;</span>
                    + &quot;email, next_email, first_name, last_name, institution, &quot;
                    + &quot;code, confirmed, folder, registration, last_login, &quot;
                    + &quot;level, country_code, max_simulations, termsUse, lastUpdatePublications,&quot;
                    + &quot;failed_authentications, account_locked &quot;
                    + &quot;FROM VIPUsers &quot;);
<span class="nc" id="L280">            List&lt;Object&gt; params = new ArrayList&lt;&gt;();</span>

<span class="nc" id="L282">            buildSearchQuery(searchCriteria)</span>
<span class="nc" id="L283">                    .ifPresent(queryEntry -&gt; {</span>
<span class="nc" id="L284">                        query.append(queryEntry.getKey());</span>
<span class="nc" id="L285">                        params.addAll(queryEntry.getValue());</span>
<span class="nc" id="L286">                    });</span>

<span class="nc" id="L288">            query.append(&quot;ORDER BY LOWER(registration)&quot;);</span>

<span class="nc" id="L290">            PreparedStatement ps = getConnection().prepareStatement(query.toString());</span>
<span class="nc" id="L291">            int paramIndex = 1;</span>
<span class="nc bnc" id="L292" title="All 2 branches missed.">            for (Object param : params) {</span>
<span class="nc" id="L293">                ps.setObject(paramIndex, param);</span>
<span class="nc" id="L294">                paramIndex++;</span>
<span class="nc" id="L295">            }</span>

<span class="nc" id="L297">            ResultSet rs = ps.executeQuery();</span>
<span class="nc" id="L298">            List&lt;User&gt; users = new ArrayList&lt;User&gt;();</span>

<span class="nc bnc" id="L300" title="All 2 branches missed.">            while (rs.next()) {</span>
<span class="nc" id="L301">                users.add(new User(</span>
<span class="nc" id="L302">                        rs.getString(&quot;first_name&quot;), rs.getString(&quot;last_name&quot;),</span>
<span class="nc" id="L303">                        rs.getString(&quot;email&quot;), rs.getString(&quot;next_email&quot;),</span>
<span class="nc" id="L304">                        rs.getString(&quot;institution&quot;),</span>
<span class="nc" id="L305">                        &quot;&quot;, rs.getBoolean(&quot;confirmed&quot;),</span>
<span class="nc" id="L306">                        rs.getString(&quot;code&quot;), rs.getString(&quot;folder&quot;), &quot;&quot;,</span>
<span class="nc" id="L307">                        new Date(rs.getTimestamp(&quot;registration&quot;).getTime()),</span>
<span class="nc" id="L308">                        new Date(rs.getTimestamp(&quot;last_login&quot;).getTime()),</span>
<span class="nc" id="L309">                        UserLevel.valueOf(rs.getString(&quot;level&quot;)),</span>
<span class="nc" id="L310">                        CountryCode.valueOf(rs.getString(&quot;country_code&quot;)),</span>
<span class="nc" id="L311">                        rs.getInt(&quot;max_simulations&quot;),</span>
<span class="nc" id="L312">                        rs.getTimestamp(&quot;termsUse&quot;),</span>
<span class="nc" id="L313">                        rs.getTimestamp(&quot;lastUpdatePublications&quot;),</span>
<span class="nc" id="L314">                        rs.getInt(&quot;failed_authentications&quot;),</span>
<span class="nc" id="L315">                        rs.getBoolean(&quot;account_locked&quot;)));</span>
            }
<span class="nc" id="L317">            ps.close();</span>
<span class="nc" id="L318">            return users;</span>

<span class="nc" id="L320">        } catch (SQLException ex) {</span>
<span class="nc" id="L321">            logger.error(&quot;Error getting all users&quot;, ex);</span>
<span class="nc" id="L322">            throw new DAOException(ex);</span>
        }
    }


    @Override
    public Long countUsers(
            UserSearchCriteria searchCriteria) throws DAOException {
        try {
<span class="nc" id="L331">            StringBuilder query = new StringBuilder(&quot;select COUNT(*) as count from VIPUsers &quot;);</span>
<span class="nc" id="L332">            List&lt;Object&gt; params = new ArrayList&lt;&gt;();</span>

<span class="nc" id="L334">            buildSearchQuery(searchCriteria)</span>
<span class="nc" id="L335">                    .ifPresent(queryEntry -&gt; {</span>
<span class="nc" id="L336">                        query.append(queryEntry.getKey());</span>
<span class="nc" id="L337">                        params.addAll(queryEntry.getValue());</span>
<span class="nc" id="L338">                    });</span>


<span class="nc" id="L341">            PreparedStatement ps = getConnection().prepareStatement(query.toString());</span>
<span class="nc" id="L342">            int paramIndex = 1;</span>
<span class="nc bnc" id="L343" title="All 2 branches missed.">            for (Object param : params) {</span>
<span class="nc" id="L344">                ps.setObject(paramIndex, param);</span>
<span class="nc" id="L345">                paramIndex++;</span>
<span class="nc" id="L346">            }</span>
<span class="nc" id="L347">            ResultSet rs = ps.executeQuery();</span>
<span class="nc bnc" id="L348" title="All 2 branches missed.">            while (rs.next()) {</span>
<span class="nc" id="L349">                return rs.getLong(&quot;count&quot;);</span>
            }
<span class="nc" id="L351">            ps.close();</span>
<span class="nc" id="L352">        } catch (SQLException ex) {</span>
<span class="nc" id="L353">            logger.error(&quot;Error getting users number&quot;, ex);</span>
<span class="nc" id="L354">            throw new DAOException(ex);</span>
<span class="nc" id="L355">        }</span>
<span class="nc" id="L356">        return -1l;</span>
    }

    private Optional&lt;Map.Entry&lt;String,List&lt;Object&gt;&gt;&gt; buildSearchQuery(
            UserSearchCriteria searchCriteria) {

<span class="nc" id="L362">        StringBuilder query = new StringBuilder();</span>
<span class="nc" id="L363">        List&lt;Object&gt; params = new ArrayList&lt;&gt;();</span>

<span class="nc bnc" id="L365" title="All 2 branches missed.">        if (searchCriteria.getRegistrationStart() != null) {</span>
<span class="nc" id="L366">            query.append(&quot;AND registration &gt;= ? &quot;);</span>
<span class="nc" id="L367">            params.add(java.sql.Date.valueOf(searchCriteria.getRegistrationStart()));</span>
        }
<span class="nc bnc" id="L369" title="All 2 branches missed.">        if (searchCriteria.getRegistrationEnd() != null) {</span>
<span class="nc" id="L370">            query.append(&quot;AND registration &lt;= ? &quot;);</span>
<span class="nc" id="L371">            params.add(java.sql.Date.valueOf(searchCriteria.getRegistrationEnd()));</span>
        }

<span class="nc bnc" id="L374" title="All 2 branches missed.">        if (searchCriteria.getCountry() != null) {</span>
<span class="nc" id="L375">            query.append(&quot;AND country_code = ? &quot;);</span>
<span class="nc" id="L376">            params.add(searchCriteria.getCountry().name());</span>
        }

<span class="nc bnc" id="L379" title="All 2 branches missed.">        if (searchCriteria.getInstitution() != null) {</span>
<span class="nc" id="L380">            query.append(&quot;AND institution = ? &quot;);</span>
<span class="nc" id="L381">            params.add(searchCriteria.getInstitution());</span>
        }

<span class="nc bnc" id="L384" title="All 2 branches missed.">        if (query.length() &gt; 0) {</span>
            // replace starting &quot;AND&quot; by &quot;WHERE&quot;
<span class="nc" id="L386">            query.replace(0, 3, &quot;WHERE&quot;);</span>
<span class="nc" id="L387">            return Optional.of(new SimpleEntry&lt;&gt;(</span>
<span class="nc" id="L388">                    query.toString(),</span>
                    params
            ));
        } else {
<span class="nc" id="L392">            return Optional.empty();</span>
        }
    }

    /**
     *
     * @param email
     * @param code
     * @return
     * @throws DAOException
     */

    // Not modified
    @Override
    public boolean activate(String email, String code) throws DAOException {

        try {
<span class="fc" id="L409">            PreparedStatement ps = getConnection().prepareStatement(&quot;SELECT &quot;</span>
                    + &quot;code,account_locked FROM VIPUsers WHERE email=?&quot;);

<span class="fc" id="L412">            ps.setString(1, email);</span>
<span class="fc" id="L413">            ResultSet rs = ps.executeQuery();</span>

<span class="pc bpc" id="L415" title="1 of 2 branches missed.">            if (rs.next()) {</span>
<span class="fc" id="L416">                String c = rs.getString(&quot;code&quot;);</span>
<span class="fc" id="L417">                boolean locked = rs.getBoolean(&quot;account_locked&quot;);</span>
<span class="pc bpc" id="L418" title="2 of 4 branches missed.">                if (!locked &amp;&amp; c.equals(code)) {</span>

<span class="fc" id="L420">                    ps = getConnection().prepareStatement(&quot;UPDATE VIPUsers SET &quot;</span>
                            + &quot;confirmed=? WHERE email=?&quot;);

<span class="fc" id="L423">                    ps.setBoolean(1, true);</span>
<span class="fc" id="L424">                    ps.setString(2, email);</span>
<span class="fc" id="L425">                    ps.executeUpdate();</span>
<span class="fc" id="L426">                    ps.close();</span>

<span class="fc" id="L428">                    return true;</span>
                }
            }
<span class="nc" id="L431">            return false;</span>

<span class="nc" id="L433">        } catch (SQLException ex) {</span>
<span class="nc" id="L434">            logger.error(&quot;Error activating user {}&quot;, email, ex);</span>
<span class="nc" id="L435">            throw new DAOException(ex);</span>
        }
    }

    /**
     *
     * @param email
     * @return
     * @throws DAOException
     */

    // Not modified
    // Throws an exception if the email we have to find is not present in the database
    @Override
    public User getUser(String email) throws DAOException {
        try
        {
<span class="fc" id="L452">            PreparedStatement ps = getConnection().prepareStatement(&quot;SELECT &quot;</span>
                    + &quot;email, next_email, pass, first_name, last_name, institution, &quot;
                    + &quot;code, confirmed, folder, session, registration, &quot;
                    + &quot;last_login, level, country_code, max_simulations,termsUse,lastUpdatePublications,failed_authentications,account_locked &quot;
                    + &quot;FROM VIPUsers &quot;
                    + &quot;WHERE email=?&quot;);

<span class="fc" id="L459">            ps.setString(1, email);</span>
<span class="fc" id="L460">            ResultSet rs = ps.executeQuery();</span>

<span class="fc bfc" id="L462" title="All 2 branches covered.">            if (rs.next()) {</span>
<span class="fc" id="L463">                User user = new User(</span>
<span class="fc" id="L464">                        rs.getString(&quot;first_name&quot;), rs.getString(&quot;last_name&quot;),</span>
<span class="fc" id="L465">                        rs.getString(&quot;email&quot;), rs.getString(&quot;next_email&quot;),</span>
<span class="fc" id="L466">                        rs.getString(&quot;institution&quot;),</span>
<span class="pc bpc" id="L467" title="1 of 2 branches missed.">                        rs.getString(&quot;pass&quot;) == null ? null : &quot;&quot;,</span>
<span class="fc" id="L468">                        rs.getBoolean(&quot;confirmed&quot;),</span>
<span class="fc" id="L469">                        rs.getString(&quot;code&quot;), rs.getString(&quot;folder&quot;),</span>
<span class="fc" id="L470">                        rs.getString(&quot;session&quot;),</span>
<span class="fc" id="L471">                        new Date(rs.getTimestamp(&quot;registration&quot;).getTime()),</span>
<span class="fc" id="L472">                        new Date(rs.getTimestamp(&quot;last_login&quot;).getTime()),</span>
<span class="fc" id="L473">                        UserLevel.valueOf(rs.getString(&quot;level&quot;)),</span>
<span class="fc" id="L474">                        CountryCode.valueOf(rs.getString(&quot;country_code&quot;)),</span>
<span class="fc" id="L475">                        rs.getInt(&quot;max_simulations&quot;),</span>
<span class="fc" id="L476">                        rs.getTimestamp(&quot;termsUse&quot;),</span>
<span class="fc" id="L477">                        rs.getTimestamp(&quot;lastUpdatePublications&quot;),</span>
<span class="fc" id="L478">                        rs.getInt(&quot;failed_authentications&quot;),</span>
<span class="fc" id="L479">                        rs.getBoolean(&quot;account_locked&quot;));</span>

<span class="fc" id="L481">                ps.close();</span>
<span class="fc" id="L482">                return user;</span>
            }
<span class="fc" id="L484">            logger.error(&quot;There is no user registered with the e-mail {}&quot;, email);</span>
<span class="fc" id="L485">            throw new DAOException(&quot;There is no user registered with the e-mail : &quot; + email);</span>

<span class="nc" id="L487">        } catch (SQLException ex) {</span>
<span class="nc" id="L488">            logger.error(&quot;Error getting user {}&quot;, email, ex);</span>
<span class="nc" id="L489">            throw new DAOException(ex);</span>
        }
    }

    /**
     *
     * @param email
     * @param password
     * @return
     * @throws DAOException
     */

    // Not modified
    @Override
    public boolean authenticate(String email, String password) throws DAOException {

        try {
<span class="nc" id="L506">            PreparedStatement ps = getConnection().prepareStatement(&quot;SELECT &quot;</span>
                    + &quot;pass,account_locked FROM VIPUsers WHERE email=?&quot;);

<span class="nc" id="L509">            ps.setString(1, email);</span>
<span class="nc" id="L510">            ResultSet rs = ps.executeQuery();</span>

<span class="nc bnc" id="L512" title="All 2 branches missed.">            if (rs.next()) {</span>
<span class="nc" id="L513">                String pass = rs.getString(&quot;pass&quot;);</span>
<span class="nc" id="L514">                boolean locked = rs.getBoolean(&quot;account_locked&quot;);</span>
<span class="nc" id="L515">                ps.close();</span>
<span class="nc bnc" id="L516" title="All 6 branches missed.">                return !locked &amp;&amp; pass != null &amp;&amp; pass.equals(password);</span>
            }
<span class="nc" id="L518">            return false;</span>

<span class="nc" id="L520">        } catch (SQLException ex) {</span>
<span class="nc" id="L521">            logger.error(&quot;Error authenticating user {}&quot;, email, ex);</span>
<span class="nc" id="L522">            throw new DAOException(ex);</span>
        }
    }

    /**
     *
     * @param email
     * @param currentPassword
     * @param newPassword
     * @throws DAOException
     */
    @Override
    public void updatePassword(String email, String currentPassword,
            String newPassword) throws DAOException {

<span class="nc bnc" id="L537" title="All 2 branches missed.">        if (authenticate(email, currentPassword)) {</span>
            try {
<span class="nc" id="L539">                PreparedStatement ps = getConnection().prepareStatement(&quot;UPDATE &quot;</span>
                        + &quot;VIPUsers SET pass = ? WHERE email = ?&quot;);

<span class="nc" id="L542">                ps.setString(1, newPassword);</span>
<span class="nc" id="L543">                ps.setString(2, email);</span>

<span class="nc" id="L545">                ps.executeUpdate();</span>
<span class="nc" id="L546">                ps.close();</span>

<span class="nc" id="L548">            } catch (SQLException ex) {</span>
<span class="nc" id="L549">                logger.error(&quot;Error updating password for {}&quot;, email,ex);</span>
<span class="nc" id="L550">                throw new DAOException(ex);</span>
<span class="nc" id="L551">            }</span>
        } else {
<span class="nc" id="L553">            logger.error(&quot;The current password mismatch for {}&quot;, email);</span>
<span class="nc" id="L554">            throw new DAOException(&quot;The current password mismatch.&quot;);</span>
        }
<span class="nc" id="L556">    }</span>

    @Override
    public void updateEmail(String oldEmail, String newEmail) throws DAOException {
        try {
<span class="nc" id="L561">            PreparedStatement ps = getConnection().prepareStatement(&quot;UPDATE &quot;</span>
                    + &quot;VIPUsers SET email = ? WHERE email = ?&quot;);

<span class="nc" id="L564">            ps.setString(1, newEmail);</span>
<span class="nc" id="L565">            ps.setString(2, oldEmail);</span>

<span class="nc" id="L567">            ps.executeUpdate();</span>
<span class="nc" id="L568">            ps.close();</span>
<span class="nc" id="L569">        } catch (SQLException ex) {</span>
<span class="nc bnc" id="L570" title="All 2 branches missed.">            if (ex.getMessage().contains(&quot;Duplicate entry&quot;)) {</span>
<span class="nc" id="L571">                logger.error(&quot;There is an existing account associated with the email: {}&quot;, newEmail);</span>
<span class="nc" id="L572">                throw new DAOException(&quot;There is an existing account associated with this email.&quot;, ex);</span>
            } else {
<span class="nc" id="L574">                logger.error(&quot;Error updating email from {} to {}&quot;, oldEmail, newEmail, ex);</span>
<span class="nc" id="L575">                throw new DAOException(ex);</span>
            }
<span class="nc" id="L577">        }</span>
<span class="nc" id="L578">    }</span>

    @Override
    public void updateNextEmail(String currentEmail, String nextEmail) throws DAOException {
        try {
<span class="nc" id="L583">            PreparedStatement ps = getConnection().prepareStatement(&quot;UPDATE &quot;</span>
                    + &quot;VIPUsers SET next_email = ? WHERE email = ?&quot;);


<span class="nc" id="L587">            ps.setString(1, nextEmail); // work even if it's null</span>
<span class="nc" id="L588">            ps.setString(2, currentEmail);</span>

<span class="nc" id="L590">            ps.executeUpdate();</span>
<span class="nc" id="L591">            ps.close();</span>
<span class="nc" id="L592">        } catch (SQLException ex) {</span>
<span class="nc" id="L593">            logger.error(&quot;Error updating next email from {} to {}&quot;, currentEmail, nextEmail, ex);</span>
<span class="nc" id="L594">            throw new DAOException(ex);</span>
<span class="nc" id="L595">        }</span>
<span class="nc" id="L596">    }</span>

    /**
     *
     * @param email
     * @param session
     * @throws DAOException
     */
    @Override
    public void updateSession(String email, String session) throws DAOException {

        try {
<span class="fc" id="L608">            PreparedStatement ps = getConnection().prepareStatement(&quot;UPDATE &quot;</span>
                    + &quot;VIPUsers SET session = ? WHERE email = ?&quot;);

<span class="fc" id="L611">            ps.setString(1, session);</span>
<span class="fc" id="L612">            ps.setString(2, email);</span>

<span class="fc" id="L614">            ps.executeUpdate();</span>
<span class="fc" id="L615">            ps.close();</span>

<span class="nc" id="L617">        } catch (SQLException ex) {</span>
<span class="nc" id="L618">            logger.error(&quot;Error updating session for {}&quot;, email, ex);</span>
<span class="nc" id="L619">            throw new DAOException(ex);</span>
<span class="fc" id="L620">        }</span>
<span class="fc" id="L621">    }</span>

    /**
     *
     * @param email
     * @param session
     * @return
     * @throws DAOException
     */
    @Override
    public boolean verifySession(String email, String session) throws DAOException {

        try {
<span class="nc" id="L634">            PreparedStatement ps = getConnection().prepareStatement(&quot;SELECT &quot;</span>
                    + &quot;session FROM VIPUsers WHERE email = ?&quot;);

<span class="nc" id="L637">            ps.setString(1, email);</span>
<span class="nc" id="L638">            ResultSet rs = ps.executeQuery();</span>

<span class="nc bnc" id="L640" title="All 2 branches missed.">            if (rs.next()) {</span>
<span class="nc" id="L641">                String sess = rs.getString(&quot;session&quot;);</span>
<span class="nc bnc" id="L642" title="All 4 branches missed.">                if (sess != null &amp;&amp; sess.equals(session)) {</span>
<span class="nc" id="L643">                    return true;</span>
                }
            }
<span class="nc" id="L646">            return false;</span>

<span class="nc" id="L648">        } catch (SQLException ex) {</span>
<span class="nc" id="L649">            logger.error(&quot;Error verifying session for {}&quot;, email, ex);</span>
<span class="nc" id="L650">            throw new DAOException(ex);</span>
        }
    }

    /**
     *
     * @param email
     * @param lastLogin
     * @throws DAOException
     */
    @Override
    public void updateLastLogin(String email, Date lastLogin) throws DAOException {

        try {
<span class="nc" id="L664">            PreparedStatement ps = getConnection().prepareStatement(&quot;UPDATE &quot;</span>
                    + &quot;VIPUsers SET last_login = ? WHERE email = ?&quot;);

<span class="nc" id="L667">            ps.setTimestamp(1, new Timestamp(lastLogin.getTime()));</span>
<span class="nc" id="L668">            ps.setString(2, email);</span>

<span class="nc" id="L670">            ps.executeUpdate();</span>
<span class="nc" id="L671">            ps.close();</span>

<span class="nc" id="L673">        } catch (SQLException ex) {</span>
<span class="nc" id="L674">            logger.error(&quot;Error updating last login to {} for {}&quot;, lastLogin, email, ex);</span>
<span class="nc" id="L675">            throw new DAOException(ex);</span>
<span class="nc" id="L676">        }</span>
<span class="nc" id="L677">    }</span>

    @Override
    public void updateTermsOfUse(String email, Timestamp termsUse) throws DAOException {

        try {
<span class="nc" id="L683">            PreparedStatement ps = getConnection().prepareStatement(&quot;UPDATE &quot;</span>
                    + &quot;VIPUsers SET termsUse = ? WHERE email = ?&quot;);

<span class="nc" id="L686">            ps.setTimestamp(1, termsUse);</span>
<span class="nc" id="L687">            ps.setString(2, email);</span>

<span class="nc" id="L689">            ps.executeUpdate();</span>
<span class="nc" id="L690">            ps.close();</span>

<span class="nc" id="L692">        } catch (SQLException ex) {</span>
<span class="nc" id="L693">            logger.error(&quot;Error updating terms of use to {} for {}&quot;, termsUse, email, ex);</span>
<span class="nc" id="L694">            throw new DAOException(ex);</span>
<span class="nc" id="L695">        }</span>
<span class="nc" id="L696">    }</span>

    /**
     *
     * @param session
     * @return
     * @throws DAOException
     */
    @Override
    public User getUserBySession(String session) throws DAOException {

        try {
<span class="nc" id="L708">            PreparedStatement ps = getConnection().prepareStatement(&quot;SELECT &quot;</span>
                    + &quot;email, next_email, first_name, last_name, institution, &quot;
                    + &quot;code, confirmed, folder, session, registration, &quot;
                    + &quot;last_login, level, country_code, max_simulations,&quot;
                    + &quot;termsUse, lastUpdatePublications, failed_authentications, account_locked &quot;
                    + &quot;FROM VIPUsers &quot;
                    + &quot;WHERE session = ?&quot;);

<span class="nc" id="L716">            ps.setString(1, session);</span>
<span class="nc" id="L717">            ResultSet rs = ps.executeQuery();</span>

<span class="nc bnc" id="L719" title="All 2 branches missed.">            if (rs.next()) {</span>
<span class="nc" id="L720">                User user = new User(</span>
<span class="nc" id="L721">                        rs.getString(&quot;first_name&quot;), rs.getString(&quot;last_name&quot;),</span>
<span class="nc" id="L722">                        rs.getString(&quot;email&quot;), rs.getString(&quot;next_email&quot;),</span>
<span class="nc" id="L723">                        rs.getString(&quot;institution&quot;),</span>
<span class="nc" id="L724">                        &quot;&quot;, rs.getBoolean(&quot;confirmed&quot;),</span>
<span class="nc" id="L725">                        rs.getString(&quot;code&quot;), rs.getString(&quot;folder&quot;),</span>
<span class="nc" id="L726">                        rs.getString(&quot;session&quot;),</span>
<span class="nc" id="L727">                        new Date(rs.getTimestamp(&quot;registration&quot;).getTime()),</span>
<span class="nc" id="L728">                        new Date(rs.getTimestamp(&quot;last_login&quot;).getTime()),</span>
<span class="nc" id="L729">                        UserLevel.valueOf(rs.getString(&quot;level&quot;)),</span>
<span class="nc" id="L730">                        CountryCode.valueOf(rs.getString(&quot;country_code&quot;)),</span>
<span class="nc" id="L731">                        rs.getInt(&quot;max_simulations&quot;),</span>
<span class="nc" id="L732">                        rs.getTimestamp(&quot;termsUse&quot;),</span>
<span class="nc" id="L733">                        rs.getTimestamp(&quot;lastUpdatePublications&quot;),</span>
<span class="nc" id="L734">                        rs.getInt(&quot;failed_authentications&quot;),</span>
<span class="nc" id="L735">                        rs.getBoolean(&quot;account_locked&quot;));</span>
<span class="nc" id="L736">                ps.close();</span>
<span class="nc" id="L737">                return user;</span>
            }

<span class="nc" id="L740">            logger.error(&quot;There is no user registered with the session: {}&quot;, session);</span>
<span class="nc" id="L741">            throw new DAOException(&quot;There is no user registered with the session: &quot; + session);</span>

<span class="nc" id="L743">        } catch (SQLException ex) {</span>
<span class="nc" id="L744">            logger.error(&quot;Error getting user from session: {}&quot;, session, ex);</span>
<span class="nc" id="L745">            throw new DAOException(ex);</span>
        }
    }

    /**
     *
     * @return @throws DAOException
     */
    @Override
    public List&lt;User&gt; getAdministrators() throws DAOException {

        try {
<span class="fc" id="L757">            PreparedStatement ps = getConnection().prepareStatement(&quot;SELECT &quot;</span>
                    + &quot;email, next_email, first_name, last_name, institution, &quot;
                    + &quot;code, confirmed, folder, registration, last_login, &quot;
                    + &quot;level, country_code, max_simulations, termsUse, &quot;
                    + &quot; lastUpdatePublications, failed_authentications, account_locked &quot;
                    + &quot;FROM VIPUsers WHERE level = ? &quot;
                    + &quot;ORDER BY LOWER(first_name), LOWER(last_name)&quot;);
<span class="fc" id="L764">            ps.setString(1, UserLevel.Administrator.name());</span>

<span class="fc" id="L766">            ResultSet rs = ps.executeQuery();</span>
<span class="fc" id="L767">            List&lt;User&gt; users = new ArrayList&lt;User&gt;();</span>

<span class="fc bfc" id="L769" title="All 2 branches covered.">            while (rs.next()) {</span>
<span class="fc" id="L770">                users.add(new User(</span>
<span class="fc" id="L771">                        rs.getString(&quot;first_name&quot;), rs.getString(&quot;last_name&quot;),</span>
<span class="fc" id="L772">                        rs.getString(&quot;email&quot;), rs.getString(&quot;next_email&quot;),</span>
<span class="fc" id="L773">                        rs.getString(&quot;institution&quot;),</span>
<span class="fc" id="L774">                        &quot;&quot;, rs.getBoolean(&quot;confirmed&quot;),</span>
<span class="fc" id="L775">                        rs.getString(&quot;code&quot;), rs.getString(&quot;folder&quot;), &quot;&quot;,</span>
<span class="fc" id="L776">                        new Date(rs.getTimestamp(&quot;registration&quot;).getTime()),</span>
<span class="fc" id="L777">                        new Date(rs.getTimestamp(&quot;last_login&quot;).getTime()),</span>
<span class="fc" id="L778">                        UserLevel.valueOf(rs.getString(&quot;level&quot;)),</span>
<span class="fc" id="L779">                        CountryCode.valueOf(rs.getString(&quot;country_code&quot;)),</span>
<span class="fc" id="L780">                        rs.getInt(&quot;max_simulations&quot;),</span>
<span class="fc" id="L781">                        rs.getTimestamp(&quot;termsUse&quot;),</span>
<span class="fc" id="L782">                        rs.getTimestamp(&quot;lastUpdatePublications&quot;),</span>
<span class="fc" id="L783">                        rs.getInt(&quot;failed_authentications&quot;),</span>
<span class="fc" id="L784">                        rs.getBoolean(&quot;account_locked&quot;)));</span>
            }
<span class="fc" id="L786">            ps.close();</span>
<span class="fc" id="L787">            return users;</span>

<span class="nc" id="L789">        } catch (SQLException ex) {</span>
<span class="nc" id="L790">            logger.error(&quot;Error getting all administrators&quot;, ex);</span>
<span class="nc" id="L791">            throw new DAOException(ex);</span>
        }
    }

    /**
     *
     * @param email
     * @param level
     * @param countryCode
     * @param maxRunningSimulations
     * @param locked
     * @throws DAOException
     */
    @Override
    public void update(String email, UserLevel level, CountryCode countryCode,
            int maxRunningSimulations, boolean locked) throws DAOException {

        try {
<span class="nc" id="L809">            PreparedStatement ps = getConnection().prepareStatement(&quot;UPDATE &quot;</span>
                    + &quot;VIPUsers SET level = ?, country_code = ?, &quot;
                    + &quot;max_simulations = ?, account_locked = ? WHERE email = ?&quot;);
<span class="nc" id="L812">            ps.setString(1, level.name());</span>
<span class="nc" id="L813">            ps.setString(2, countryCode.name());</span>
<span class="nc" id="L814">            ps.setInt(3, maxRunningSimulations);</span>
<span class="nc" id="L815">            ps.setBoolean(4, locked);</span>
<span class="nc" id="L816">            ps.setString(5, email);</span>

<span class="nc" id="L818">            ps.executeUpdate();</span>
<span class="nc" id="L819">            ps.close();</span>

<span class="nc" id="L821">        } catch (SQLException ex) {</span>
<span class="nc" id="L822">            logger.error(&quot;Error updating user {}&quot;, email, ex);</span>
<span class="nc" id="L823">            throw new DAOException(ex);</span>
<span class="nc" id="L824">        }</span>
<span class="nc" id="L825">    }</span>

    /**
     *
     * @param email
     * @param code
     * @throws DAOException
     */
    @Override
    public void updateCode(String email, String code) throws DAOException {

        try {
<span class="nc" id="L837">            PreparedStatement ps = getConnection().prepareStatement(&quot;UPDATE &quot;</span>
                    + &quot;VIPUsers SET code = ? WHERE email = ?&quot;);
<span class="nc" id="L839">            ps.setString(1, code);</span>
<span class="nc" id="L840">            ps.setString(2, email);</span>

<span class="nc" id="L842">            ps.executeUpdate();</span>
<span class="nc" id="L843">            ps.close();</span>

<span class="nc" id="L845">        } catch (SQLException ex) {</span>
<span class="nc" id="L846">            logger.error(&quot;Error updating code to {} for user {}&quot;, code, email, ex);</span>
<span class="nc" id="L847">            throw new DAOException(ex);</span>
<span class="nc" id="L848">        }</span>
<span class="nc" id="L849">    }</span>

    /**
     *
     * @param email
     * @param newPassword
     * @throws DAOException
     */
    @Override
    public void resetPassword(String email, String newPassword) throws DAOException {

        try {
<span class="nc" id="L861">            PreparedStatement ps = getConnection().prepareStatement(&quot;UPDATE &quot;</span>
                    + &quot;VIPUsers SET pass = ? WHERE email = ?&quot;);

<span class="nc" id="L864">            ps.setString(1, newPassword);</span>
<span class="nc" id="L865">            ps.setString(2, email);</span>
<span class="nc" id="L866">            ps.executeUpdate();</span>
<span class="nc" id="L867">            ps.close();</span>

<span class="nc" id="L869">        } catch (SQLException ex) {</span>
<span class="nc" id="L870">            logger.error(&quot;Error resetting password for user {}&quot;, email, ex);</span>
<span class="nc" id="L871">            throw new DAOException(ex);</span>
<span class="nc" id="L872">        }</span>
<span class="nc" id="L873">    }</span>

    @Override
    public int getNUsers() throws DAOException {
        try {
<span class="nc" id="L878">            PreparedStatement ps = getConnection().prepareStatement(&quot;select COUNT(*) as count from VIPUsers&quot;);</span>
<span class="nc" id="L879">            ResultSet rs = ps.executeQuery();</span>
<span class="nc bnc" id="L880" title="All 2 branches missed.">            while (rs.next()) {</span>
<span class="nc" id="L881">                return rs.getInt(&quot;count&quot;);</span>
            }
<span class="nc" id="L883">            ps.close();</span>
<span class="nc" id="L884">        } catch (SQLException ex) {</span>
<span class="nc" id="L885">            logger.error(&quot;Error getting users number&quot;, ex);</span>
<span class="nc" id="L886">            throw new DAOException(ex);</span>
<span class="nc" id="L887">        }</span>
<span class="nc" id="L888">        return -1;</span>
    }

    @Override
    public int getNCountries() throws DAOException {
        try {
<span class="nc" id="L894">            PreparedStatement ps = getConnection().prepareStatement(&quot;select COUNT(distinct country_code) as count from VIPUsers&quot;);</span>
<span class="nc" id="L895">            ResultSet rs = ps.executeQuery();</span>
<span class="nc bnc" id="L896" title="All 2 branches missed.">            while (rs.next()) {</span>
<span class="nc" id="L897">                return rs.getInt(&quot;count&quot;);</span>
            }
<span class="nc" id="L899">            ps.close();</span>
<span class="nc" id="L900">        } catch (SQLException ex) {</span>
<span class="nc" id="L901">            logger.error(&quot;Error getting countries number&quot;, ex);</span>
<span class="nc" id="L902">            throw new DAOException(ex);</span>
<span class="nc" id="L903">        }</span>
<span class="nc" id="L904">        return -1;</span>
    }

    @Override
    public Timestamp getLastPublicationUpdate(String email) throws DAOException {
        try {
<span class="nc" id="L910">            Timestamp lastupdatePublication = null;</span>
<span class="nc" id="L911">            PreparedStatement ps = getConnection().prepareStatement(&quot;SELECT lastUpdatePublications &quot;</span>
                    + &quot;FROM VIPUsers WHERE email=?&quot;);

<span class="nc" id="L914">            ps.setString(1, email);</span>
<span class="nc" id="L915">            ResultSet rs = ps.executeQuery();</span>
<span class="nc bnc" id="L916" title="All 2 branches missed.">            while (rs.next()) {</span>
<span class="nc" id="L917">                lastupdatePublication = rs.getTimestamp(&quot;lastUpdatePublications&quot;);</span>
            }

<span class="nc" id="L920">            ps.close();</span>
<span class="nc" id="L921">            return lastupdatePublication;</span>

<span class="nc" id="L923">        } catch (SQLException ex) {</span>
<span class="nc" id="L924">            logger.error(&quot;Error getting last publication update for {}&quot;, email, ex);</span>
<span class="nc" id="L925">            throw new DAOException(ex);</span>
        }
    }

    @Override
    public void updateLastUpdatePublication(String email, Timestamp lastUpdatePublication) throws DAOException {
        try {
<span class="nc" id="L932">            PreparedStatement ps = getConnection().prepareStatement(&quot;UPDATE &quot;</span>
                    + &quot;VIPUsers SET lastUpdatePublications = ? WHERE email = ?&quot;);

<span class="nc" id="L935">            ps.setTimestamp(1, lastUpdatePublication);</span>
<span class="nc" id="L936">            ps.setString(2, email);</span>
<span class="nc" id="L937">            ps.executeUpdate();</span>
<span class="nc" id="L938">            ps.close();</span>

<span class="nc" id="L940">        } catch (SQLException ex) {</span>
<span class="nc" id="L941">            logger.error(&quot;Error updating last publication to {} for {}&quot;, lastUpdatePublication, email, ex);</span>
<span class="nc" id="L942">            throw new DAOException(ex);</span>
<span class="nc" id="L943">        }</span>
<span class="nc" id="L944">    }</span>

    @Override
    public int getNFailedAuthentications(String email) throws DAOException {
<span class="nc" id="L948">        int n = 0;</span>
        try {
<span class="nc" id="L950">            PreparedStatement ps = getConnection().prepareStatement(&quot;SELECT failed_authentications FROM VIPUsers WHERE email=?&quot;);</span>

<span class="nc" id="L952">            ps.setString(1, email);</span>
<span class="nc" id="L953">            ResultSet rs = ps.executeQuery();</span>
<span class="nc bnc" id="L954" title="All 2 branches missed.">            while (rs.next()) {</span>
<span class="nc" id="L955">                n = rs.getInt(&quot;failed_authentications&quot;);</span>
            }

<span class="nc" id="L958">            ps.close();</span>
<span class="nc" id="L959">            return n;</span>

<span class="nc" id="L961">        } catch (SQLException ex) {</span>
<span class="nc" id="L962">            logger.error(&quot;Error getting failed auth number for {}&quot;, email, ex);</span>
<span class="nc" id="L963">            throw new DAOException(ex);</span>
        }
    }

    @Override
    public void lock(String email) throws DAOException {
        try {
<span class="nc" id="L970">            PreparedStatement ps = getConnection().prepareStatement(&quot;UPDATE &quot;</span>
                    + &quot;VIPUsers SET &quot;
                    + &quot;account_locked=1 &quot;
                    + &quot;WHERE email = ?&quot;);

<span class="nc" id="L975">            ps.setString(1, email);</span>

<span class="nc" id="L977">            ps.executeUpdate();</span>
<span class="nc" id="L978">            ps.close();</span>

<span class="nc" id="L980">        } catch (SQLException ex) {</span>
<span class="nc" id="L981">            logger.error(&quot;Error locking {}&quot;, email, ex);</span>
<span class="nc" id="L982">            throw new DAOException(ex);</span>
<span class="nc" id="L983">        }</span>
<span class="nc" id="L984">    }</span>

    @Override
    public void unlock(String email) throws DAOException {
         try {
<span class="nc" id="L989">            PreparedStatement ps = getConnection().prepareStatement(&quot;UPDATE &quot;</span>
                    + &quot;VIPUsers SET &quot;
                    + &quot;account_locked=0, failed_authentications=0 &quot;
                    + &quot;WHERE email = ?&quot;);

<span class="nc" id="L994">            ps.setString(1, email);</span>

<span class="nc" id="L996">            ps.executeUpdate();</span>
<span class="nc" id="L997">            ps.close();</span>

<span class="nc" id="L999">        } catch (SQLException ex) {</span>
<span class="nc" id="L1000">             logger.error(&quot;Error unlocking {}&quot;, email, ex);</span>
<span class="nc" id="L1001">             throw new DAOException(ex);</span>
<span class="nc" id="L1002">        }</span>
<span class="nc" id="L1003">    }</span>

    @Override
    public void resetNFailedAuthentications(String email) throws DAOException {
         try {
<span class="fc" id="L1008">            PreparedStatement ps = getConnection().prepareStatement(&quot;UPDATE &quot;</span>
                    + &quot;VIPUsers SET &quot;
                    + &quot;failed_authentications=0 &quot;
                    + &quot;WHERE email = ?&quot;);

<span class="fc" id="L1013">            ps.setString(1, email);</span>

<span class="fc" id="L1015">            ps.executeUpdate();</span>
<span class="fc" id="L1016">            ps.close();</span>

<span class="nc" id="L1018">        } catch (SQLException ex) {</span>
<span class="nc" id="L1019">             logger.error(&quot;Error resetting failed auth number for {}&quot;, email, ex);</span>
<span class="nc" id="L1020">            throw new DAOException(ex);</span>
<span class="fc" id="L1021">        }</span>
<span class="fc" id="L1022">    }</span>

    @Override
    public void incNFailedAuthentications(String email) throws DAOException {
         try {
<span class="nc" id="L1027">            PreparedStatement ps = getConnection().prepareStatement(&quot;UPDATE &quot;</span>
                    + &quot;VIPUsers SET &quot;
                    + &quot;failed_authentications = failed_authentications + 1 &quot;
                    + &quot;WHERE email = ?&quot;);

<span class="nc" id="L1032">            ps.setString(1, email);</span>

<span class="nc" id="L1034">            ps.executeUpdate();</span>
<span class="nc" id="L1035">            ps.close();</span>

<span class="nc" id="L1037">        } catch (SQLException ex) {</span>
<span class="nc" id="L1038">             logger.error(&quot;Error increasing failed auth number for {}&quot;, email, ex);</span>
<span class="nc" id="L1039">            throw new DAOException(ex);</span>
<span class="nc" id="L1040">        }</span>
<span class="nc" id="L1041">    }</span>

    @Override
    public boolean isLocked(String email) throws DAOException {
<span class="fc" id="L1045">        boolean locked = true;</span>
        try {
<span class="fc" id="L1047">            PreparedStatement ps = getConnection().prepareStatement(&quot;SELECT account_locked FROM VIPUsers WHERE email=?&quot;);</span>

<span class="fc" id="L1049">            ps.setString(1, email);</span>
<span class="fc" id="L1050">            ResultSet rs = ps.executeQuery();</span>
<span class="fc bfc" id="L1051" title="All 2 branches covered.">            while (rs.next()) {</span>
<span class="fc" id="L1052">                locked = rs.getBoolean(&quot;account_locked&quot;);</span>
            }

<span class="fc" id="L1055">            ps.close();</span>
<span class="fc" id="L1056">            return locked;</span>

<span class="nc" id="L1058">        } catch (SQLException ex) {</span>
<span class="nc" id="L1059">            logger.error(&quot;Error checking if {} is locked&quot;, email, ex);</span>
<span class="nc" id="L1060">            throw new DAOException(ex);</span>
        }
    }

    @Override
    public User getUserByApikey(String apikey) throws DAOException {
        try {
<span class="nc" id="L1067">            PreparedStatement ps = getConnection().prepareStatement(</span>
                    &quot;SELECT email FROM VIPUsers WHERE apikey=?&quot;);

<span class="nc" id="L1070">            ps.setString(1, apikey);</span>
<span class="nc" id="L1071">            ResultSet rs = ps.executeQuery();</span>
<span class="nc bnc" id="L1072" title="All 2 branches missed.">            if (rs.next()) {</span>
<span class="nc" id="L1073">                String email = rs.getString(&quot;email&quot;);</span>
<span class="nc" id="L1074">                ps.close();</span>
<span class="nc" id="L1075">                return getUser(email);</span>
            }
<span class="nc" id="L1077">            ps.close();</span>

<span class="nc" id="L1079">            logger.error(&quot;There is no user registered with the key: &quot; + apikey);</span>
<span class="nc" id="L1080">            throw new DAOException(&quot;There is no user registered with the key : &quot; + apikey);</span>

<span class="nc" id="L1082">        } catch (SQLException ex) {</span>
<span class="nc" id="L1083">            logger.error(&quot;Error getting user by api key for {}&quot;, apikey, ex);</span>
<span class="nc" id="L1084">            throw new DAOException(ex);</span>
        }
    }

    @Override
    public String getUserApikey(String email) throws DAOException {
        try {
<span class="fc" id="L1091">            PreparedStatement ps = getConnection().prepareStatement(</span>
                    &quot;SELECT apikey FROM VIPUsers WHERE email=?&quot;);

<span class="fc" id="L1094">            ps.setString(1, email);</span>
<span class="fc" id="L1095">            ResultSet rs = ps.executeQuery();</span>
<span class="fc bfc" id="L1096" title="All 2 branches covered.">            if (rs.next()) {</span>
<span class="fc" id="L1097">                String apikey = rs.getString(&quot;apikey&quot;);</span>
<span class="fc" id="L1098">                ps.close();</span>
<span class="fc" id="L1099">                return apikey;</span>
            }
<span class="fc" id="L1101">            ps.close();</span>

<span class="fc" id="L1103">            logger.error(&quot;There is no user registered with the e-mail {}&quot;, email);</span>
<span class="fc" id="L1104">            throw new DAOException(&quot;There is no user registered with the e-mail : &quot; + email);</span>

<span class="nc" id="L1106">        } catch (SQLException ex) {</span>
<span class="nc" id="L1107">            logger.error(&quot;Error getting user api key for {}&quot;, email, ex);</span>
<span class="nc" id="L1108">            throw new DAOException(ex);</span>
        }
    }

    @Override
    public void updateUserApikey(String email, String newApikey) throws DAOException {
        try {
<span class="fc" id="L1115">            PreparedStatement ps = getConnection().prepareStatement(&quot;UPDATE &quot;</span>
                    + &quot;VIPUsers SET apikey = ? WHERE email = ?&quot;);

<span class="fc" id="L1118">            ps.setString(1, newApikey);</span>
<span class="fc" id="L1119">            ps.setString(2, email);</span>
<span class="fc" id="L1120">            int rowsUpdatedNb = ps.executeUpdate();</span>
<span class="fc" id="L1121">            ps.close();</span>

<span class="fc bfc" id="L1123" title="All 2 branches covered.">            if (rowsUpdatedNb == 0) {</span>
<span class="fc" id="L1124">                logger.error(&quot;There is no user registered with the e-mail {}&quot;, email);</span>
<span class="fc" id="L1125">                throw new DAOException(&quot;There is no user registered with the e-mail : &quot; + email);</span>
            }
<span class="nc" id="L1127">        } catch (SQLException ex) {</span>
<span class="nc" id="L1128">            logger.error(&quot;Error updating {} api key to {}&quot;, email, newApikey, ex);</span>
<span class="nc" id="L1129">            throw new DAOException(ex);</span>
<span class="fc" id="L1130">        }</span>
<span class="fc" id="L1131">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span></div></body></html>