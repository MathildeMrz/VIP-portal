<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>LaunchFormLayout.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">coverage</a> &gt; <a href="../index.html" class="el_bundle">vip-application</a> &gt; <a href="index.source.html" class="el_package">fr.insalyon.creatis.vip.application.client.view.launch</a> &gt; <span class="el_source">LaunchFormLayout.java</span></div><h1>LaunchFormLayout.java</h1><pre class="source lang-java linenums">package fr.insalyon.creatis.vip.application.client.view.launch;

import com.google.gwt.user.client.rpc.AsyncCallback;
import com.smartgwt.client.types.Cursor;
import com.smartgwt.client.types.VerticalAlignment;
import com.smartgwt.client.util.SC;
import com.smartgwt.client.widgets.Canvas;
import com.smartgwt.client.widgets.IButton;
import com.smartgwt.client.widgets.Label;
import com.smartgwt.client.widgets.layout.HLayout;
import com.smartgwt.client.widgets.layout.Layout;
import com.smartgwt.client.widgets.layout.VLayout;
import fr.insalyon.creatis.vip.application.client.ApplicationConstants;
import fr.insalyon.creatis.vip.application.client.bean.Descriptor;
import fr.insalyon.creatis.vip.application.client.bean.boutiquesTools.*;
import fr.insalyon.creatis.vip.application.client.rpc.ApplicationService;
import fr.insalyon.creatis.vip.application.client.view.boutiquesParsing.InvalidBoutiquesDescriptorException;
import fr.insalyon.creatis.vip.core.client.view.CoreConstants;
import fr.insalyon.creatis.vip.core.client.view.common.AbstractFormLayout;
import fr.insalyon.creatis.vip.core.client.view.util.WidgetUtil;
import fr.insalyon.creatis.vip.datamanager.client.DataManagerConstants;

import java.util.*;
import java.util.function.BiFunction;
import java.util.function.Function;
import java.util.stream.Collectors;

import static fr.insalyon.creatis.vip.core.client.view.CoreConstants.RESULTS_DIRECTORY_PARAM_NAME;

/**
 * Launch form automatically generated from a Boutiques descriptor.
 *
 * @author Guillaume Vanel
 * @version %I%, %G%
 */
public class LaunchFormLayout extends AbstractFormLayout {
    public static final String EXECUTION_NAME_ID = &quot;Execution-name&quot;;
    // Application information
    protected String applicationName;
    protected String applicationVersion;
    protected String applicationClass;
    // Maps from input/group IDs to corresponding object
<span class="nc" id="L43">    private final Map&lt;String, InputLayout&gt; inputsMap = new HashMap&lt;&gt;();</span>
<span class="nc" id="L44">    private final Map&lt;String, GroupValidator&gt; groups = new HashMap&lt;&gt;();</span>
    // Buttons
    private final HLayout buttonsLayout;
<span class="nc" id="L47">    private  IButton launchButton = null;</span>
<span class="nc" id="L48">    private  IButton saveInputsButton = null;</span>
<span class="nc" id="L49">    private  IButton saveAsExampleButton = null;</span>
    // customization
<span class="nc" id="L51">    private boolean disableErrorsAndWarnings = false;</span>
    // Label warning user about unsupported dependencies (due to one of the inputs having multiple values)
    private final Label warningLabel;
    // Maps the problematic input ID to the set of dependencies that can't be supported because of it
<span class="nc" id="L55">    private final Map&lt;String, Set&lt;String&gt;&gt; unsupportedDependencies = new HashMap&lt;&gt;();</span>
    // Label pointing out errors in the form
    private final Label errorLabel;
    // Names of the inputs with invalid values
<span class="nc" id="L59">    private final Set&lt;String&gt; invalidInputIds = new TreeSet&lt;&gt;();</span>
    // Other error messages (unsatisfied groups)
<span class="nc" id="L61">    private final Set&lt;String&gt; errorMessages = new TreeSet&lt;&gt;();</span>

    /**
     * Assertion that given expression is true, else an IllegalStateException with given message is thrown
     *
     * @param expression boolean: expression to verify, should evaluate to true in normal execution
     * @param message    String message of thrown exception when expression is false
     * @throws IllegalStateException if expression is false
     */
    public static void assertCondition (boolean expression, String message) throws IllegalStateException{
<span class="nc bnc" id="L71" title="All 2 branches missed.">        if(!expression){</span>
<span class="nc" id="L72">            throw new IllegalStateException(message);</span>
        }
<span class="nc" id="L74">    }</span>

    /**
     * @param text  String
     * @return      String with content from text enclosed by HTML bold tag
     */
    public static String bold(String text) {
<span class="nc" id="L81">        return &quot;&lt;b&gt;&quot; + text + &quot;&lt;/b&gt;&quot;;</span>
    }

    /**
     * @param  memberNames List of Strings containing a group's member names
     * @return             String message describing the group as mutually exclusive
     */
    public static String mutuallyExclusiveMessage(List&lt;String&gt; memberNames) {
<span class="nc" id="L89">        return groupMessage(memberNames, names -&gt; &quot;At most one of &quot; + names + &quot; can be non-empty.&quot;);</span>
    }

    /**
     * @param  memberNames List of Strings containing a group's member names
     * @return             String message describing the group as all-or-none
     */
    public static String allOrNoneMessage(List&lt;String&gt; memberNames) {
<span class="nc" id="L97">        return groupMessage(memberNames, names -&gt; &quot;Either all or none of &quot; + names + &quot; must be empty.&quot;);</span>
    }

    /**
     * @param  memberNames List of Strings containing a group's member names
     * @return             String message describing the group as one-is-required
     */
    public static String oneIsRequiredMessage(List&lt;String&gt; memberNames) {
<span class="nc" id="L105">        return groupMessage(memberNames, names -&gt; &quot;At least one of &quot; + names + &quot; must be non-empty.&quot;);</span>
    }

    /**
     * Generate a String description of a group from its members and a message formatter function
     *
     * @param memberNames       List of Strings containing names of group member inputs
     * @param messageFormatter  Function returning a group description as String from a String argument that lists
     *                          the group members
     * @return                  String description of the group
     */
    private static String groupMessage(List&lt;String&gt; memberNames, Function&lt;String, String&gt; messageFormatter){
<span class="nc" id="L117">        return messageFormatter.apply(bold(memberNames.toString()));</span>
    }

    /**
     * Initialize all visual elements
     *
     * @param applicationDescriptor     BoutiquesApplication generated from application .json descriptor file
     */
    public LaunchFormLayout(final BoutiquesApplication applicationDescriptor, boolean showSeparators) {
<span class="nc" id="L126">        super(&quot;600&quot;, &quot;*&quot;);</span>
<span class="nc" id="L127">        this.setWidth(600);</span>
        // Documentation
<span class="nc" id="L129">        Label docLabel = WidgetUtil.getLabel(&quot;Documentation and Terms of Use&quot;,</span>
                CoreConstants.ICON_INFORMATION, 30, Cursor.HAND);
<span class="nc" id="L131">        docLabel.addClickHandler(event -&gt; new DocumentationLayout(event.getX(), event.getY(),</span>
<span class="nc" id="L132">                applicationDescriptor.getDescription()).show());</span>
<span class="nc" id="L133">        this.addMember(docLabel);</span>
        // Buttons
<span class="nc" id="L135">        this.buttonsLayout = new HLayout(5);</span>
<span class="nc" id="L136">        this.buttonsLayout.setAlign(VerticalAlignment.CENTER);</span>
<span class="nc" id="L137">        this.buttonsLayout.setMargin(20);</span>
        // Error message
<span class="nc" id="L139">        this.errorLabel = WidgetUtil.getLabel(&quot;&quot;, CoreConstants.ICON_WARNING, 30);</span>
<span class="nc" id="L140">        this.errorLabel.setWidth(430);</span>
<span class="nc" id="L141">        this.errorLabel.hide();</span>
        // Warning message
<span class="nc" id="L143">        this.warningLabel = WidgetUtil.getLabel(&quot;&quot;, CoreConstants.ICON_HELP, 30);</span>
<span class="nc" id="L144">        this.warningLabel.setWidth(430);</span>
<span class="nc" id="L145">        this.warningLabel.hide();</span>
        // verify there are extensions
<span class="nc bnc" id="L147" title="All 2 branches missed.">        assertCondition(applicationDescriptor.getBoutiquesExtensions() != null,</span>
                &quot;The boutiques descriptor must have extensions&quot;);
        // Add inputs, then buttons and warning/error labels below
<span class="nc" id="L150">        this.configureInputs(applicationDescriptor, showSeparators);</span>
<span class="nc" id="L151">        this.addMember(buttonsLayout);</span>
<span class="nc" id="L152">        this.addMember(this.errorLabel);</span>
<span class="nc" id="L153">        this.addMember(this.warningLabel);</span>
        // Groups
<span class="nc bnc" id="L155" title="All 2 branches missed.">        for(BoutiquesGroup group : applicationDescriptor.getGroups()){</span>
<span class="nc" id="L156">            this.groups.put(group.getId(), new GroupValidator(group, this));</span>
<span class="nc" id="L157">        }</span>
<span class="nc" id="L158">        this.validateGroups();</span>
        // Dependencies
<span class="nc" id="L160">        this.configureDependencies(applicationDescriptor);</span>
<span class="nc" id="L161">    }</span>

    public void hideInputs() {
<span class="nc" id="L164">        setInputsVisible(false);</span>
<span class="nc" id="L165">    }</span>

    public void showInputs() {
<span class="nc" id="L168">        setInputsVisible(true);</span>
<span class="nc" id="L169">    }</span>

    private void setInputsVisible(Boolean visible) {
<span class="nc bnc" id="L172" title="All 2 branches missed.">        for (InputLayout inputLayout : inputsMap.values()) {</span>
<span class="nc bnc" id="L173" title="All 2 branches missed.">            if (inputLayout.getInputId().equals(EXECUTION_NAME_ID)) {</span>
<span class="nc" id="L174">                continue;</span>
            }
<span class="nc" id="L176">            inputLayout.setVisible(visible);</span>
<span class="nc" id="L177">        }</span>
<span class="nc" id="L178">    }</span>

    public void hideInput(String inputId) {
<span class="nc bnc" id="L181" title="All 2 branches missed.">        for (InputLayout inputLayout : inputsMap.values()) {</span>
<span class="nc bnc" id="L182" title="All 2 branches missed.">            if (inputLayout.getInputId().equals(inputId)) {</span>
<span class="nc" id="L183">                inputLayout.setVisible(false);</span>
            }
<span class="nc" id="L185">        }</span>
<span class="nc" id="L186">    }</span>

    public void makeInputUnmodifiable(String inputId) {
<span class="nc bnc" id="L189" title="All 2 branches missed.">        for (InputLayout inputLayout : inputsMap.values()) {</span>
<span class="nc bnc" id="L190" title="All 2 branches missed.">            if (inputLayout.getInputId().equals(inputId)) {</span>
<span class="nc" id="L191">                inputLayout.makeUnmodifiablePermanently();</span>
            }
<span class="nc" id="L193">        }</span>
<span class="nc" id="L194">    }</span>

    public void disableErrorsAndWarnings() {
<span class="nc" id="L197">        this.disableErrorsAndWarnings = true;</span>
<span class="nc" id="L198">        this.errorLabel.hide();</span>
<span class="nc" id="L199">        this.warningLabel.hide();</span>
<span class="nc" id="L200">    }</span>

    public void enableErrorsAndWarnings() {
<span class="nc" id="L203">        this.disableErrorsAndWarnings = false;</span>
<span class="nc" id="L204">        this.updateWarningMessage();</span>
<span class="nc" id="L205">        this.updateErrorMessages();</span>
<span class="nc" id="L206">    }</span>

    /**
     * Add given launch, save inputs and save as example buttons to this
     *
     * @param launchButton          IButton
     * @param saveInputsButton      IButton
     * @param saveAsExampleButton   IButton, or null
     */
    public void setButtons(IButton launchButton, IButton saveInputsButton, IButton saveAsExampleButton) {
<span class="nc" id="L216">        this.launchButton = launchButton;</span>
<span class="nc" id="L217">        this.saveInputsButton = saveInputsButton;</span>
        HLayout layout;
<span class="nc bnc" id="L219" title="All 2 branches missed.">        if(saveAsExampleButton == null){</span>
<span class="nc" id="L220">            layout = getButtonLayout(20, launchButton, saveInputsButton);</span>
        } else {
<span class="nc" id="L222">            this.saveAsExampleButton = saveAsExampleButton;</span>
<span class="nc" id="L223">            layout = getButtonLayout(20, launchButton, saveInputsButton, saveAsExampleButton);</span>
        }
<span class="nc" id="L225">        this.setButtonsLayout(layout);</span>
<span class="nc" id="L226">        this.updateErrorMessages();</span>
<span class="nc" id="L227">    }</span>

    /**
     * Add given buttons to this
     *
     *  @param margin   int margin before added buttons
     * @param buttons   IButton... to add to this
     */
    public void setButtons(int margin, IButton... buttons) {
<span class="nc" id="L236">        this.setButtonsLayout(getButtonLayout(margin, buttons));</span>
<span class="nc" id="L237">    }</span>

    protected HLayout getButtonLayout(int margin, IButton... buttons) {
<span class="nc" id="L240">        HLayout newButtonLayout = new HLayout(5);</span>
<span class="nc" id="L241">        newButtonLayout.setAlign(VerticalAlignment.CENTER);</span>
<span class="nc" id="L242">        newButtonLayout.setMargin(margin);</span>

<span class="nc bnc" id="L244" title="All 2 branches missed.">        for (IButton button : buttons) {</span>
<span class="nc" id="L245">            newButtonLayout.addMember(button);</span>
        }
<span class="nc" id="L247">        return newButtonLayout;</span>
    }

    private void setButtonsLayout(Layout newButtonsLayout) {
<span class="nc bnc" id="L251" title="All 2 branches missed.">        for (Canvas child : this.buttonsLayout.getChildren()) {</span>
<span class="nc" id="L252">            this.buttonsLayout.removeChild(child);</span>
        }
<span class="nc" id="L254">        this.buttonsLayout.addMember(newButtonsLayout);</span>
<span class="nc" id="L255">    }</span>


    public void configureCitation(String applicationName) {

<span class="nc" id="L260">        AsyncCallback&lt;String&gt; callback = new AsyncCallback&lt;String&gt;() {</span>
            @Override
            public void onFailure(Throwable caught) {
<span class="nc" id="L263">                fr.insalyon.creatis.vip.core.client.view.layout.Layout.getInstance().setWarningMessage(&quot;Unable to load citation:&lt;br /&gt;&quot; + caught.getMessage());</span>
<span class="nc" id="L264">            }</span>

            @Override
            public void onSuccess(String result) {
<span class="nc bnc" id="L268" title="All 4 branches missed.">                if (result != null &amp;&amp; !result.isEmpty()) {</span>
<span class="nc" id="L269">                    VLayout citationLayout = new VLayout(5);</span>
<span class="nc" id="L270">                    citationLayout.addMember(WidgetUtil.getLabel(&quot;&lt;b&gt;Please refer to the following publication:&lt;/b&gt;&quot;, 20));</span>

<span class="nc" id="L272">                    Label citation = new Label(result);</span>
<span class="nc" id="L273">                    citation.setWidth100();</span>
<span class="nc" id="L274">                    citation.setAutoHeight();</span>
<span class="nc" id="L275">                    citation.setCanSelectText(true);</span>
<span class="nc" id="L276">                    citation.setPadding(5);</span>
<span class="nc" id="L277">                    citation.setBackgroundColor(&quot;#FFFFFF&quot;);</span>
<span class="nc" id="L278">                    citation.setBorder(&quot;1px solid #CCCCCC&quot;);</span>
<span class="nc" id="L279">                    citationLayout.addMember(citation);</span>

<span class="nc" id="L281">                    addMember(citationLayout);</span>
                }
<span class="nc" id="L283">            }</span>
        };
<span class="nc" id="L285">        ApplicationService.Util.getInstance().getCitation(applicationName, callback);</span>
<span class="nc" id="L286">    }</span>

    /**
     * Generate forms for results directory inputs as well as all inputs described in applicationDescriptor
     *
     * @param applicationDescriptor BoutiquesDescriptor generated from application .json descriptor file
     */
    private void configureInputs(BoutiquesApplication applicationDescriptor, boolean showSeparators) {
        // Execution name and results directory inputs
<span class="nc bnc" id="L295" title="All 2 branches missed.">        if (showSeparators) {</span>
<span class="nc" id="L296">            Label separator = WidgetUtil.getLabel(&quot;&lt;hr/&gt;Mandatory inputs :&quot;, 15);</span>
<span class="nc" id="L297">            this.addMember(separator);</span>
        }

        try {
<span class="nc" id="L301">            this.createArtificialStringInput(&quot;Execution name&quot;, EXECUTION_NAME_ID, false, null,</span>
                    false, &quot;[&quot; + ApplicationConstants.EXEC_NAME_VALID_CHARS + &quot;]&quot;);
<span class="nc bnc" id="L303" title="All 2 branches missed.">            if(applicationDescriptor.getBoutiquesExtensions().getAddResultsDirectoryInput()) {</span>
<span class="nc" id="L304">                this.createArtificialStringInput(&quot;Results directory&quot;, RESULTS_DIRECTORY_PARAM_NAME, true,</span>
                        DataManagerConstants.ROOT + &quot;/&quot; + DataManagerConstants.USERS_HOME,
                        true, &quot;[&quot; + ApplicationConstants.INPUT_VALID_CHARS + &quot;]&quot;);
            }
<span class="nc" id="L308">        } catch (InvalidBoutiquesDescriptorException exception) {</span>
            // This should not happen as parameters provided to createArtificialStringInput should be valid.
<span class="nc" id="L310">            throw new RuntimeException(&quot;Could not create 'Execution name' and 'Results directory' input layouts.&quot;);</span>
<span class="nc" id="L311">        }</span>
        // Application descriptor inputs
<span class="nc" id="L313">        Set&lt;BoutiquesInput&gt; mandatoryInputs = applicationDescriptor.getInputs().stream()</span>
<span class="nc bnc" id="L314" title="All 2 branches missed.">                .filter(i -&gt; ! i.isOptional()).collect(Collectors.toSet());</span>
<span class="nc" id="L315">        Set&lt;BoutiquesInput&gt; optionalInputs = applicationDescriptor.getInputs().stream()</span>
<span class="nc" id="L316">                .filter(i -&gt; i.isOptional()).collect(Collectors.toSet());</span>


<span class="nc bnc" id="L319" title="All 2 branches missed.">        for (BoutiquesInput input : mandatoryInputs) {</span>
<span class="nc" id="L320">            configureInput(applicationDescriptor, input);</span>
<span class="nc" id="L321">        }</span>
<span class="nc bnc" id="L322" title="All 2 branches missed.">        if (optionalInputs.isEmpty()) {</span>
<span class="nc" id="L323">            return;</span>
        }
<span class="nc bnc" id="L325" title="All 2 branches missed.">        if (showSeparators) {</span>
<span class="nc" id="L326">            Label separator = WidgetUtil.getLabel(&quot;&lt;hr/&gt;Optional inputs :&quot;, 15);</span>
<span class="nc" id="L327">            this.addMember(separator);</span>
        }

<span class="nc bnc" id="L330" title="All 2 branches missed.">        for (BoutiquesInput input : optionalInputs) {</span>
<span class="nc" id="L331">            configureInput(applicationDescriptor, input);</span>
<span class="nc" id="L332">        }</span>
<span class="nc" id="L333">    }</span>

    private void configureInput(BoutiquesApplication applicationDescriptor, BoutiquesInput input) {
        InputLayout inputLayout;
<span class="nc bnc" id="L337" title="All 2 branches missed.">        if(input.getPossibleValues() != null){</span>
<span class="nc" id="L338">            Map&lt;String, String&gt; labels =</span>
<span class="nc" id="L339">                    applicationDescriptor.getBoutiquesExtensions().getValueChoicesLabelsForInput(input.getId());</span>
<span class="nc" id="L340">            inputLayout = new ValueChoiceInputLayout(input, this, labels);</span>
<span class="nc" id="L341">        } else {</span>
<span class="nc bnc" id="L342" title="All 4 branches missed.">            switch (input.getType()) {</span>
                case STRING:
                case FILE:
<span class="nc" id="L345">                    String allowedChar = &quot;[&quot; + ApplicationConstants.INPUT_VALID_CHARS + &quot;]&quot;;</span>
<span class="nc" id="L346">                    inputLayout = new StringInputLayout((BoutiquesStringInput) input, this,</span>
                            true, allowedChar);
<span class="nc" id="L348">                    break;</span>
                case NUMBER:
<span class="nc" id="L350">                    inputLayout = new NumberInputLayout((BoutiquesNumberInput) input, this);</span>
<span class="nc" id="L351">                    break;</span>
                case FLAG:
<span class="nc" id="L353">                    inputLayout = new FlagInputLayout((BoutiquesFlagInput) input, this);</span>
<span class="nc" id="L354">                    break;</span>
                default:
<span class="nc" id="L356">                    throw new RuntimeException(&quot;Unknown input type: &quot; + input.getType());</span>
            }
        }
        // handle extensions
<span class="nc bnc" id="L360" title="All 2 branches missed.">        if (applicationDescriptor.getBoutiquesExtensions().getNonListInputs().contains(input.getId())) {</span>
<span class="nc" id="L361">            inputLayout.disableAddingValue();</span>
        }
<span class="nc" id="L363">        this.inputsMap.put(input.getId(), inputLayout);</span>
<span class="nc" id="L364">        this.addMember(inputLayout);</span>
        // Validate input value and dependencies
<span class="nc" id="L366">        inputLayout.onValueChanged();</span>
<span class="nc" id="L367">    }</span>

    /**
     * Create and displays an artificial String input from its attributes (used for execution name and results
     * directory)
     *
     * @param name              String name of the input
     * @param id                String input ID
     * @param isFile            boolean: true if input is a File, false if it is a free String
     * @param defaultValue      input default value (&quot;&quot; for empty default)
     * @param hasAddValueButton boolean: true if input should have a &quot;add value&quot; button, false otherwise
     * @param allowedChar       String representing a regexp of allowed characters (ex: &quot;[a-zA-z0-9]&quot; for alphanumeric).
     *                          null with use default value &quot;[&quot; + ApplicationConstants.INPUT_VALID_CHARS + &quot;]&quot;.
     * @throws InvalidBoutiquesDescriptorException if provided properties are invalid
     */
    private void createArtificialStringInput(String name, String id, boolean isFile,
                                             String defaultValue, boolean hasAddValueButton, String allowedChar)
            throws InvalidBoutiquesDescriptorException {
<span class="nc bnc" id="L385" title="All 2 branches missed.">        BoutiquesInput.InputType type = isFile ? BoutiquesInput.InputType.FILE : BoutiquesInput.InputType.STRING;</span>
<span class="nc" id="L386">        BoutiquesStringInput input = new BoutiquesStringInput(id, name, null, type, false,</span>
                null, null, null, null,null,
                defaultValue);
<span class="nc" id="L389">        InputLayout inputLayout = new StringInputLayout(input, this, hasAddValueButton, allowedChar);</span>
<span class="nc" id="L390">        this.inputsMap.put(id, inputLayout);</span>
<span class="nc" id="L391">        this.addMember(inputLayout);</span>
<span class="nc" id="L392">        inputLayout.onValueChanged();</span>
<span class="nc" id="L393">    }</span>

    /**
     * Add inter-inputs dependencies.
     * Preconditions: this.inputsMap has already been populated with correct InputLayouts (using this.configureInputs)
     *                this.groups has already been populated with correct GroupValidators (by constructor)
     *
     * @param applicationDescriptor BoutiquesDescriptor generated from application .json descriptor file
     */
    private void configureDependencies(BoutiquesApplication applicationDescriptor) {
        // Disables-inputs
<span class="nc" id="L404">        applicationDescriptor.getDisablesInputsMap().forEach(this::addDisablesInputs);</span>
        // Requires-inputs
<span class="nc" id="L406">        applicationDescriptor.getRequiresInputsMap().forEach(this::addRequiresInputs);</span>
        // Value-disables
<span class="nc" id="L408">        applicationDescriptor.getValueDisablesInputsMap().forEach(this::addValueDisables);</span>
        // Value-requires
<span class="nc" id="L410">        applicationDescriptor.getValueRequiresInputsMap().forEach(this::addValueRequires);</span>
<span class="nc" id="L411">    }</span>

    /**
     * Make input with ID masterID disable all optional inputs with IDs in disabledIds when it is not empty
     *  @param masterId      String representing disabling input ID
     * @param disabledIds    Set of String IDs of dependent inputs
     */
    private void addDisablesInputs(String masterId, Set&lt;String&gt; disabledIds) {
<span class="nc" id="L419">        assertCondition(this.inputsMap.containsKey(masterId),</span>
                &quot;Invalid master input ID: &quot; + masterId);
<span class="nc" id="L421">        InputLayout masterInput = this.inputsMap.get(masterId);</span>
<span class="nc bnc" id="L422" title="All 2 branches missed.">        for (String disabledInputId : disabledIds) {</span>
<span class="nc" id="L423">            assertCondition(this.inputsMap.containsKey(disabledInputId),</span>
                    &quot;Invalid disabled input ID: &quot; + disabledInputId);
<span class="nc" id="L425">            InputLayout disabledInput = this.inputsMap.get(disabledInputId);</span>
            // Add dependency only if disabledInput can indeed be disabled, which means it is optional
<span class="nc bnc" id="L427" title="All 2 branches missed.">            if(disabledInput.isOptional()) {</span>
<span class="nc" id="L428">                masterInput.addDisables(disabledInput);</span>
            }
<span class="nc" id="L430">        }</span>
<span class="nc" id="L431">    }</span>

    /**
     * Make input with ID masterID require all inputs and groups with IDs in requiredIds. This means it will be disabled
     * if one of them is left empty
     *  @param masterId     String representing dependent input ID
     * @param requiredIds   Set of String IDs of required inputs or groups of inputs
     */
    private void addRequiresInputs(String masterId, Set&lt;String&gt; requiredIds) {
<span class="nc" id="L440">        assertCondition(this.inputsMap.containsKey(masterId), &quot;Invalid master input ID: &quot; + masterId);</span>
<span class="nc" id="L441">        InputLayout masterInput = this.inputsMap.get(masterId);</span>
        // Ignore dependency if master input is not optional (thus cannot be disabled)
<span class="nc bnc" id="L443" title="All 2 branches missed.">        if(!masterInput.isOptional()) {</span>
<span class="nc" id="L444">            return;</span>
        }
<span class="nc bnc" id="L446" title="All 2 branches missed.">        for (String requiredInputId : requiredIds) {</span>
<span class="nc bnc" id="L447" title="All 2 branches missed.">            if (this.inputsMap.containsKey(requiredInputId)) {</span>
<span class="nc" id="L448">                InputLayout requiredInput = this.inputsMap.get(requiredInputId);</span>
<span class="nc" id="L449">                masterInput.addRequires(requiredInput);</span>
<span class="nc" id="L450">            } else {</span>
                // A whole group is required
<span class="nc" id="L452">                LaunchFormLayout.assertCondition(this.groups.containsKey(requiredInputId),</span>
                        &quot;Invalid group ID: &quot; + requiredInputId);
<span class="nc bnc" id="L454" title="All 2 branches missed.">                for (InputLayout requiredMember : this.groups.get(requiredInputId).getMembers()) {</span>
<span class="nc" id="L455">                    masterInput.addRequires(requiredMember);</span>
<span class="nc" id="L456">                }</span>
            }
<span class="nc" id="L458">        }</span>
<span class="nc" id="L459">    }</span>

    /**
     * Make input with ID masterId values disable certain inputs. valueDisablesIds maps values to IDs of inputs disabled
     * when these values are selected.
     *  @param masterId          String representing disabling input ID.
     * @param valueDisablesIds   Map from String input values to Sets of String IDs of inputs disabled by those values
     */
    private void addValueDisables(String masterId, Map&lt;String, Set&lt;String&gt;&gt; valueDisablesIds) {
<span class="nc" id="L468">        LaunchFormLayout.assertCondition(this.inputsMap.containsKey(masterId),</span>
                &quot;Invalid master input ID: &quot; + masterId);
<span class="nc" id="L470">        InputLayout masterInput = this.inputsMap.get(masterId);</span>
<span class="nc" id="L471">        LaunchFormLayout.assertCondition(masterInput instanceof ValueChoiceInputLayout,</span>
                &quot;Invalid state: can't add value-disables to non value choice input: &quot; + masterId);
<span class="nc bnc" id="L473" title="All 2 branches missed.">        for (String iValue : valueDisablesIds.keySet()) {</span>
<span class="nc" id="L474">            Set&lt;InputLayout&gt; disabledInputSet = new HashSet&lt;&gt;();</span>
<span class="nc bnc" id="L475" title="All 2 branches missed.">            for (String disabledInputId : valueDisablesIds.get(iValue)) {</span>
<span class="nc" id="L476">                LaunchFormLayout.assertCondition(this.inputsMap.containsKey(disabledInputId),</span>
                        &quot;Invalid disabled input ID: &quot; + disabledInputId);
<span class="nc" id="L478">                InputLayout disabledInput = this.inputsMap.get(disabledInputId);</span>
                // Only optional inputs can be disabled
<span class="nc bnc" id="L480" title="All 2 branches missed.">                if(disabledInput.isOptional()) {</span>
<span class="nc" id="L481">                    disabledInputSet.add(disabledInput);</span>
                }
<span class="nc" id="L483">            }</span>
<span class="nc" id="L484">            ((ValueChoiceInputLayout) masterInput).addValueDisables(iValue, disabledInputSet);</span>
<span class="nc" id="L485">        }</span>
<span class="nc" id="L486">    }</span>

    /**
     * Make input with ID masterId values require certain inputs. valueRequiresIds maps values to IDs of inputs that
     * cannot be empty when these values are selected.
     *  @param masterId          String representing dependent input ID.
     * @param valueRequiresIds   Map from input values as Strings to Set of String IDs of inputs required by those
     *                          values
     */
    private void addValueRequires(String masterId, Map&lt;String, Set&lt;String&gt;&gt; valueRequiresIds) {
<span class="nc" id="L496">        LaunchFormLayout.assertCondition(this.inputsMap.containsKey(masterId),</span>
                &quot;Invalid master input ID: &quot; + masterId);
<span class="nc" id="L498">        InputLayout masterInput = this.inputsMap.get(masterId);</span>
<span class="nc" id="L499">        LaunchFormLayout.assertCondition(masterInput instanceof ValueChoiceInputLayout,</span>
                &quot;Can't add value-requires to non value choice input: &quot; + masterId);
<span class="nc" id="L501">        Map&lt;String, Set&lt;InputLayout&gt;&gt; valueRequiresLayouts = new HashMap&lt;&gt;();</span>
<span class="nc bnc" id="L502" title="All 2 branches missed.">        for (String iValue : valueRequiresIds.keySet()) {</span>
<span class="nc" id="L503">            Set&lt;InputLayout&gt; requiredInputs = valueRequiresIds.get(iValue).stream()</span>
<span class="nc" id="L504">                    .map(this.inputsMap::get)</span>
<span class="nc" id="L505">                    .collect(Collectors.toSet());</span>
<span class="nc" id="L506">            valueRequiresLayouts.put(iValue, requiredInputs);</span>
<span class="nc" id="L507">        }</span>
<span class="nc" id="L508">        ((ValueChoiceInputLayout) masterInput).addValueRequires(valueRequiresLayouts);</span>
<span class="nc" id="L509">    }</span>

    /**
     * Validate groups using corresponding GroupValidators validate method. This adds
     */
    public void validateGroups() {
<span class="nc" id="L515">        this.groups.values().forEach(GroupValidator::validate);</span>
<span class="nc" id="L516">    }</span>

    /**
     * Add dependencies involving masterInput to unsupported dependencies, usually because the input has
     * multiple values. A warning message will be displayed to inform user
     *
     * @param masterInput   InputLayout representing problematic input
     * @see #removeUnsupportedDependencies(String)
     * @see #updateWarningMessage()
     */
    public void addUnsupportedDependencies(InputLayout masterInput){
<span class="nc" id="L527">        final String masterName = bold(masterInput.getInputName());</span>
        Set&lt;String&gt; newUnsupportedDependencies; // Warning messages to display
        // Requires-inputs
<span class="nc" id="L530">        newUnsupportedDependencies = this.formatDependencies(masterInput.getRequires(),</span>
<span class="nc" id="L531">                inputName -&gt; masterName + &quot; requires &quot; + inputName);</span>
<span class="nc" id="L532">        newUnsupportedDependencies.addAll(this.formatDependencies(masterInput.getRequiredBy(),</span>
<span class="nc" id="L533">                inputName -&gt; inputName + &quot; requires &quot; + masterName));</span>
        // Disables-inputs
<span class="nc" id="L535">        newUnsupportedDependencies.addAll(this.formatDependencies(masterInput.getDisables(),</span>
<span class="nc" id="L536">                inputName -&gt; masterName + &quot; disables &quot; + inputName));</span>
<span class="nc" id="L537">        newUnsupportedDependencies.addAll(this.formatDependencies(masterInput.getDisabledBy(),</span>
<span class="nc" id="L538">                inputName -&gt; inputName + &quot; disables &quot; + masterName));</span>
        // Value-disables
<span class="nc" id="L540">        newUnsupportedDependencies.addAll(this.formatDependencies(masterInput.getRequiredByValue(),</span>
<span class="nc" id="L541">                (inputName, values) -&gt; inputName + &quot; values &quot; + values + &quot; require &quot; + masterName));</span>
        // Value-requires
<span class="nc" id="L543">        newUnsupportedDependencies.addAll(this.formatDependencies(masterInput.getDisabledByValue(),</span>
<span class="nc" id="L544">                (inputName, values) -&gt; inputName + &quot; values &quot; + values + &quot; disable &quot; + masterName));</span>
<span class="nc bnc" id="L545" title="All 2 branches missed.">        if(masterInput instanceof ValueChoiceInputLayout){</span>
<span class="nc" id="L546">            ValueChoiceInputLayout masterChoiceInput = (ValueChoiceInputLayout) masterInput;</span>
            // Value-disables
<span class="nc" id="L548">            newUnsupportedDependencies.addAll(this.formatDependencies(masterChoiceInput.getValueDisables(),</span>
<span class="nc" id="L549">                    (inputName, values) -&gt; masterName + &quot; values &quot; + values + &quot; disable &quot; + inputName));</span>
            // Value-requires
<span class="nc" id="L551">            newUnsupportedDependencies.addAll(this.formatDependencies(masterChoiceInput.getValueRequires(),</span>
<span class="nc" id="L552">                    (inputName, values) -&gt; masterName + &quot; values &quot; + values + &quot; require &quot; + inputName));</span>
        }
        // Update warning message
<span class="nc bnc" id="L555" title="All 2 branches missed.">        if(newUnsupportedDependencies.size() &gt; 0){</span>
<span class="nc" id="L556">            this.unsupportedDependencies.put(masterInput.getInputId(), newUnsupportedDependencies);</span>
        }
<span class="nc" id="L558">        this.updateWarningMessage();</span>
<span class="nc" id="L559">    }</span>

    /**
     * Generate a set of dependency messages from a set of InputLayouts involved in the dependencies. A formatter
     * Function generates one dependency message given involved input's name
     *
     * @param inputSet  Set of InputLayout involved in dependencies to describe
     * @param formatter Function taking a String containing an input name as argument and returning a String
     *                  representing the dependency its involved in
     * @return          Set of Strings containing dependency messages
     * @see #addUnsupportedDependencies(InputLayout)
     */
    private Set&lt;String&gt; formatDependencies(Set&lt;InputLayout&gt; inputSet,
                                           Function&lt;String, String&gt; formatter) {
<span class="nc" id="L573">        return inputSet.stream()</span>
<span class="nc" id="L574">                .map(input -&gt; bold(input.getInputName()))</span>
<span class="nc" id="L575">                .map(formatter)</span>
<span class="nc" id="L576">                .collect(Collectors.toSet());</span>
    }

    /**
     * Generate a set of dependency messages from a Map containing InputLayouts and input values involved in the
     * dependencies. A formatter BiFunction generates one dependency message given involved input's name and
     * involved Set of values.
     *
     * @param valueChoices  Map containing InputLayouts as keys and Sets of Strings as values. These respectively
     *                      represent inputs and input values involved together in a dependency
     * @param formatter     BiFunction taking two Strings as arguments and returning a dependency message as String.
     *                      Arguments are respectively involved input's name and the list of involved input values
     * @return              Set of Strings containing dependency messages
     * @see #addUnsupportedDependencies(InputLayout)
     */
    private Set&lt;String&gt; formatDependencies(Map&lt;InputLayout, Set&lt;String&gt;&gt; valueChoices,
                                           BiFunction&lt;String, String, String&gt; formatter) {
<span class="nc" id="L593">        return valueChoices.entrySet().stream()</span>
<span class="nc" id="L594">                .map(entry -&gt; formatter.apply(bold(entry.getKey().getInputName()), entry.getValue().toString()))</span>
<span class="nc" id="L595">                .collect(Collectors.toSet());</span>
    }

    /**
     * Remove dependencies involving input with ID masterId from unsupported dependencies, then update corresponding
     * warning message
     *
     * @param masterId  String containing involved input's ID
     * @see #addUnsupportedDependencies(InputLayout)
     * @see #updateWarningMessage()
     */
    public void removeUnsupportedDependencies(String masterId){
<span class="nc" id="L607">        this.unsupportedDependencies.remove(masterId);</span>
<span class="nc" id="L608">        this.updateWarningMessage();</span>
<span class="nc" id="L609">    }</span>

    /**
     * Add dependencies involving unsupportedGroup to unsupported dependencies, usually because the group input has
     * members with multiple values. A warning message will be displayed to inform user
     *
     * @param unsupportedGroup  GroupValidator representing problematic group
     * @see #addUnsupportedDependencies(InputLayout)
     * @see #updateWarningMessage()
     */
    public void addUnsupportedGroup(GroupValidator unsupportedGroup) {
<span class="nc" id="L620">        HashSet&lt;String&gt; newUnsupportedDependencies = new HashSet&lt;&gt;();</span>
<span class="nc" id="L621">        List&lt;String&gt; memberNames = unsupportedGroup.getMemberNames();</span>
<span class="nc bnc" id="L622" title="All 2 branches missed.">        if(unsupportedGroup.isMutuallyExclusive()){</span>
<span class="nc" id="L623">            newUnsupportedDependencies.add(mutuallyExclusiveMessage(memberNames));</span>
        }
<span class="nc bnc" id="L625" title="All 2 branches missed.">        if(unsupportedGroup.isAllOrNone()){</span>
<span class="nc" id="L626">            newUnsupportedDependencies.add(allOrNoneMessage(memberNames));</span>
        }
<span class="nc bnc" id="L628" title="All 2 branches missed.">        if(unsupportedGroup.isOneIsRequired()){</span>
<span class="nc" id="L629">            newUnsupportedDependencies.add(oneIsRequiredMessage(memberNames));</span>
        }
<span class="nc bnc" id="L631" title="All 2 branches missed.">        if(newUnsupportedDependencies.size() &gt; 0){</span>
<span class="nc" id="L632">            this.unsupportedDependencies.put(unsupportedGroup.getGroupId(), newUnsupportedDependencies);</span>
<span class="nc" id="L633">            newUnsupportedDependencies.forEach(message -&gt; this.groupErrorMessage(message, false));</span>
        }
<span class="nc" id="L635">        this.updateWarningMessage();</span>
<span class="nc" id="L636">    }</span>

    /**
     * Remove dependencies involving group with ID nowSupportedGroup from unsupported dependencies, then update
     * corresponding warning message
     *
     * @param nowSupportedGroup  GroupValidator representing the group
     * @see #addUnsupportedGroup(GroupValidator) 
     * @see #removeUnsupportedDependencies(String)
     * @see #updateWarningMessage()
     */
    public void removeUnsupportedGroup(GroupValidator nowSupportedGroup) {
<span class="nc" id="L648">        this.unsupportedDependencies.remove(nowSupportedGroup.getGroupId());</span>
<span class="nc" id="L649">        this.updateWarningMessage();</span>
<span class="nc" id="L650">    }</span>

    /**
     * Update this.warningLabel to show current user warnings. Hide it if there is no warning to show
     */
    public void updateWarningMessage(){
<span class="nc bnc" id="L656" title="All 2 branches missed.">        if (this.disableErrorsAndWarnings) return;</span>

<span class="nc" id="L658">        Set&lt;String&gt; warningDependencies = new TreeSet&lt;&gt;();</span>
<span class="nc" id="L659">        this.unsupportedDependencies.forEach((keyId, warnings) -&gt; warningDependencies.addAll(warnings));</span>
<span class="nc bnc" id="L660" title="All 2 branches missed.">        if(warningDependencies.size() == 0){</span>
<span class="nc" id="L661">            this.warningLabel.hide();</span>
        } else {
<span class="nc" id="L663">            String message = warningDependencies.stream()</span>
<span class="nc" id="L664">                    .map(dependency -&gt; &quot;&lt;li&gt; &quot; + dependency + &quot;&lt;/li&gt;&quot;)</span>
<span class="nc" id="L665">                    .collect(Collectors.joining(&quot;&quot;, &quot;&lt;font color=\&quot;orange\&quot;&gt;Following input &quot;</span>
                            + &quot;dependencies can't be checked because some inputs have multiple values. Please ensure &quot;
                            + &quot;they are met to avoid execution errors: &lt;ul&gt;&quot;, &quot;&lt;/ul&gt;&quot;));
<span class="nc" id="L668">            this.warningLabel.setContents(message);</span>
<span class="nc" id="L669">            this.warningLabel.show();</span>
        }
<span class="nc" id="L671">    }</span>

    /**
     * Add an InputLayout input name to the list of inputs with invalid value, then update user error messages
     *
     * @param input InputLayout representing problematic input
     * @see #removeValidationErrorOnInput(InputLayout)
     * @see #updateErrorMessages()
     * @see #addUnsupportedDependencies(InputLayout)
     */
    public void addValidationErrorOnInput(InputLayout input) {
<span class="nc" id="L682">        this.invalidInputIds.add(input.getInputId());</span>
<span class="nc" id="L683">        this.updateErrorMessages();</span>
<span class="nc" id="L684">    }</span>

    /**
     * Remove an InputLayout input name from the list of inputs with invalid value, then update user error messages
     *
     * @param input InputLayout representing concerned input
     * @see #addValidationErrorOnInput(InputLayout)
     * @see #updateErrorMessages()
     * @see #removeUnsupportedDependencies(String)
     */
    public void removeValidationErrorOnInput(InputLayout input) {
<span class="nc" id="L695">        this.invalidInputIds.remove(input.getInputId());</span>
<span class="nc" id="L696">        this.updateErrorMessages();</span>
<span class="nc" id="L697">    }</span>
    
    /**
     * Add or remove a group from unsatisfied group error messages, then update visible error messages
     *
     * @param message   String containing the group error message to add or remove
     * @param addError  boolean: true if the error message should be added, false if it should be removed
     * @see #addValidationErrorOnInput(InputLayout)
     * @see #removeValidationErrorOnInput(InputLayout)
     * @see #updateErrorMessages()
     */
    public void groupErrorMessage(String message, boolean addError) {
<span class="nc bnc" id="L709" title="All 2 branches missed.">        if(addError) {</span>
<span class="nc" id="L710">            this.errorMessages.add(message);</span>
        } else {
<span class="nc" id="L712">            this.errorMessages.remove(message);</span>
        }
<span class="nc" id="L714">        this.updateErrorMessages();</span>
<span class="nc" id="L715">    }</span>

    /**
     * Update displayed user error messages to match field invalidInputNames and errorMessages. If there is no error
     * to display, also enable launch simulation, save inputs and save as example buttons, else disable them
     * 
     * @see #addValidationErrorOnInput(InputLayout)
     * @see #removeValidationErrorOnInput(InputLayout)
     * @see #groupErrorMessage(String, boolean) 
     */
    public void updateErrorMessages() {
<span class="nc bnc" id="L726" title="All 2 branches missed.">        if (this.disableErrorsAndWarnings) return;</span>

<span class="nc bnc" id="L728" title="All 2 branches missed.">        if ((this.invalidInputIds.size() + this.errorMessages.size()) == 0){</span>
            // No errors: enable buttons and hide error messages label
<span class="nc bnc" id="L730" title="All 4 branches missed.">            if((this.launchButton != null) &amp;&amp; (this.saveInputsButton != null)) {</span>
<span class="nc" id="L731">                this.launchButton.enable();</span>
<span class="nc" id="L732">                this.launchButton.setPrompt(&quot;&quot;);</span>
<span class="nc" id="L733">                this.saveInputsButton.enable();</span>
<span class="nc" id="L734">                this.saveInputsButton.setPrompt(&quot;&quot;);</span>
            }
<span class="nc bnc" id="L736" title="All 2 branches missed.">            if(this.saveAsExampleButton != null) {</span>
<span class="nc" id="L737">                this.saveAsExampleButton.enable();</span>
<span class="nc" id="L738">                this.saveAsExampleButton.setPrompt(&quot;Save the inputs as a featured example that will &quot;</span>
                        + &quot;be available for all users.&quot;);
            }
<span class="nc" id="L741">            this.errorLabel.hide();</span>
        } else {
            // Errors: disable buttons and show error messages
<span class="nc bnc" id="L744" title="All 4 branches missed.">            if((this.launchButton != null) &amp;&amp; (this.saveInputsButton != null)) {</span>
<span class="nc" id="L745">                this.launchButton.disable();</span>
<span class="nc" id="L746">                this.launchButton.setPrompt(&quot;Cannot launch. Some inputs are not valid (see below).&quot;);</span>
<span class="nc" id="L747">                this.saveInputsButton.disable();</span>
<span class="nc" id="L748">                this.saveInputsButton.setPrompt(&quot;Cannot save Inputs. Some inputs are not valid (see below).&quot;);</span>
            }
<span class="nc bnc" id="L750" title="All 2 branches missed.">            if(this.saveAsExampleButton != null) {</span>
<span class="nc" id="L751">                this.saveAsExampleButton.disable();</span>
<span class="nc" id="L752">                this.saveAsExampleButton.setPrompt(&quot;Cannot save Inputs. Some inputs are not valid (see below).&quot;);</span>
            }
<span class="nc" id="L754">            this.errorLabel.show();</span>
            // Error messages
<span class="nc" id="L756">            StringBuilder errorContent = new StringBuilder(&quot;&lt;font color=\&quot;red\&quot;&gt;&lt;ul&gt;&quot;);</span>
<span class="nc bnc" id="L757" title="All 2 branches missed.">            if(this.invalidInputIds.size() &gt; 0) {</span>
<span class="nc" id="L758">                Set&lt;String&gt; invalidInputNames = this.invalidInputIds.stream()</span>
<span class="nc" id="L759">                        .map(id -&gt; this.inputsMap.get(id).getInputName())</span>
<span class="nc" id="L760">                        .collect(Collectors.toSet());</span>
<span class="nc" id="L761">                errorContent.append(&quot;&lt;li&gt;Following inputs are invalid: &lt;b&gt;&quot;)</span>
<span class="nc" id="L762">                        .append(invalidInputNames)</span>
<span class="nc" id="L763">                        .append(&quot;&lt;/b&gt;.&lt;/li&gt;&quot;);</span>
            }
<span class="nc" id="L765">            this.errorMessages.forEach(iMessage -&gt; errorContent.append(&quot;&lt;li&gt;&quot;).append(iMessage).append(&quot;&lt;/li&gt;&quot;));</span>
<span class="nc" id="L766">            this.errorLabel.setContents(errorContent + &quot;&lt;/ul&gt;&quot;);</span>
        }
<span class="nc" id="L768">    }</span>

    /**
     * Returns a map of input IDs to corresponding input values represented as ValueSets
     *
     * @return Map with String containing input IDs as keys and ValuesSets representing input values as values
     */
    private Map&lt;String, ValueSet&gt; getInputValueMap() {
<span class="nc" id="L776">        Map&lt;String, ValueSet&gt; inputValuesMap = new HashMap&lt;&gt;();</span>
<span class="nc" id="L777">        this.inputsMap.forEach((inputId, inputLayout) -&gt; inputValuesMap.put(inputId, inputLayout.getValueList()));</span>
<span class="nc" id="L778">        return inputValuesMap;</span>
    }

    /**
     * Returns a map of input IDs to corresponding input values represented as one String
     *
     * @return Map with String containing input IDs as keys and String representing input values as values
     */
    public Map&lt;String, String&gt; getParametersMap() {
<span class="nc" id="L787">        Map&lt;String, String&gt; parameterMap = new HashMap&lt;&gt;();</span>
<span class="nc" id="L788">        this.getInputValueMap().forEach((inputId, valueSet) -&gt; {</span>
<span class="nc bnc" id="L789" title="All 2 branches missed.">            if(!inputId.equals(EXECUTION_NAME_ID)) {</span>
                String inputValue;
<span class="nc bnc" id="L791" title="All 2 branches missed.">                if (valueSet instanceof ValueList) {</span>
<span class="nc" id="L792">                    inputValue = String.join(ApplicationConstants.SEPARATOR_LIST, valueSet.getValuesAsStrings());</span>
                } else {
<span class="nc" id="L794">                    List&lt;Float&gt; startStepStop = ((ValueRange) valueSet).getRangeLimits();</span>
<span class="nc" id="L795">                    inputValue = startStepStop.get(0) + ApplicationConstants.SEPARATOR_INPUT</span>
<span class="nc" id="L796">                            + startStepStop.get(2) + ApplicationConstants.SEPARATOR_INPUT</span>
<span class="nc" id="L797">                            + startStepStop.get(1);</span>
                }
<span class="nc" id="L799">                parameterMap.put(inputId, inputValue);</span>
            }
<span class="nc" id="L801">        });</span>
<span class="nc" id="L802">        return parameterMap;</span>
    }

    /**
     * Load saved values after confirming with user if some non default values are to be overwritten
     *
     * @param valueMap Map of String representing input IDs to ValueSet representing corresponding values to load
     */
    private void loadValueMap(final Map&lt;String, ValueSet&gt; valueMap, boolean askConfirmation) {
        // Check if some inputs have non default values that will be overwritten with different values,
        // in order to alert the user
<span class="nc" id="L813">        Set&lt;String&gt; overwrittenInputs = new TreeSet&lt;&gt;();</span>
<span class="nc bnc" id="L814" title="All 2 branches missed.">        for(String inputId : valueMap.keySet()) {</span>
<span class="nc" id="L815">            InputLayout input = this.inputsMap.get(inputId);</span>
<span class="nc" id="L816">            boolean overwriteInput = false;</span>
<span class="nc" id="L817">            ValueSet currentValueList = input.getValueList();</span>
<span class="nc" id="L818">            ValueSet loadedValueList = valueMap.get(inputId);</span>
<span class="nc bnc" id="L819" title="All 2 branches missed.">            if (!currentValueList.isEqualTo(loadedValueList)) {</span>
<span class="nc bnc" id="L820" title="All 2 branches missed.">                if (!input.hasUniqueValue()) {</span>
<span class="nc" id="L821">                    overwriteInput = true;</span>
                } else {
                    // Overwrite only if current value is different from default value.
<span class="nc" id="L824">                    Object uniqueValue = currentValueList.getValueNo(0);</span>
<span class="nc" id="L825">                    Object defaultValue = input.getDefaultValue();</span>
<span class="nc bnc" id="L826" title="All 4 branches missed.">                    if( ! ((uniqueValue == null) &amp;&amp; (defaultValue == null)) ){</span>
<span class="nc bnc" id="L827" title="All 4 branches missed.">                        if((uniqueValue == null) || (defaultValue == null)){</span>
                            // Current value or default value is null while the other is not
<span class="nc" id="L829">                            overwriteInput = true;</span>
                        } else {
                            // String comparison in case defaultValue is not the same type as uniqueValue.
                            // For instance if descriptor has default value &quot;1&quot; for an input of type &quot;Number&quot;, we want
                            // the Float value 1 to be considered equal to default.
<span class="nc bnc" id="L834" title="All 2 branches missed.">                            if(!defaultValue.toString().equals(uniqueValue.toString())){</span>
<span class="nc" id="L835">                                overwriteInput = true;</span>
                            }
                        }
                    }
                }
            }
<span class="nc bnc" id="L841" title="All 2 branches missed.">            if (overwriteInput) {</span>
<span class="nc" id="L842">                overwrittenInputs.add(input.getInputId());</span>
            }
<span class="nc" id="L844">        }</span>
        // If some values are to be overwritten, ask user to confirm
<span class="nc bnc" id="L846" title="All 4 branches missed.">        if (overwrittenInputs.size() == 0 || ! askConfirmation) {</span>
<span class="nc" id="L847">            this.overwriteValues(valueMap);</span>
        } else {
<span class="nc" id="L849">            Set&lt;String&gt; overwrittenNames =  overwrittenInputs.stream()</span>
<span class="nc" id="L850">                    .map(id -&gt; this.inputsMap.get(id).getInputName())</span>
<span class="nc" id="L851">                    .collect(Collectors.toSet());</span>
<span class="nc" id="L852">            SC.confirm(&quot;The following fields already have a value.&lt;br /&gt;&quot;</span>
                            + &quot;Do you want to replace them?&lt;br /&gt;&quot;
                            + &quot;Fields: &quot; + overwrittenNames,
                    confirmed -&gt; {
<span class="nc bnc" id="L856" title="All 2 branches missed.">                        if(confirmed){</span>
<span class="nc" id="L857">                            this.overwriteValues(valueMap);</span>
                        }
<span class="nc" id="L859">                    });</span>
        }
<span class="nc" id="L861">    }</span>

    /**
     * Overwrite current in put values with provided ones
     *
     * @param valueMap  Map of String representing input IDs to ValueSet representing corresponding values to write
     */
    private void overwriteValues(Map&lt;String, ValueSet&gt; valueMap) {
<span class="nc" id="L869">        valueMap.forEach((inputId, values) -&gt; this.inputsMap.get(inputId).overwriteValues(values));</span>
<span class="nc" id="L870">    }</span>

    /**
     * Load inputs from a parameters map
     *
     * @param simulationName Execution name to load
     * @param valuesMap      Map of String input IDs to String representation of corresponding input values
     */
    public void loadInputs( String simulationName, Map&lt;String, String&gt; valuesMap, boolean askConfirmation) {
<span class="nc" id="L879">        Map&lt;String, ValueSet&gt; valueSetMap = new HashMap&lt;&gt;();</span>
<span class="nc" id="L880">        valueSetMap.put(EXECUTION_NAME_ID, ValueSet.valueSetFactory(simulationName));</span>
<span class="nc" id="L881">        valuesMap.forEach((inputId, valueString) -&gt; valueSetMap.put(inputId, ValueSet.valueSetFactory(valueString)));</span>
<span class="nc" id="L882">        this.loadValueMap(valueSetMap, askConfirmation);</span>
<span class="nc" id="L883">    }</span>

    /**
     * @return Map of String representing IDs of inputs contained in this form to corresponding InputLayouts
     */
    public Map&lt;String, InputLayout&gt; getInputsMap() {
<span class="nc" id="L889">        return this.inputsMap;</span>
    }

    /**
     * @return Simulation name
     */
    public String getSimulationName() {
<span class="nc" id="L896">        return this.getInputValueMap().get(EXECUTION_NAME_ID).getStringValueNo(0);</span>
    }

    /**
     * @return boolean: true if all inputs and groups are valid, false otherwise
     */
    public boolean validate() {
<span class="nc bnc" id="L903" title="All 2 branches missed.">        return (this.invalidInputIds.size() + this.errorMessages.size()) == 0;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span></div></body></html>